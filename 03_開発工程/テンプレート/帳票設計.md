# 帳票設計書

## 1. 帳票設計方針

### 帳票の定義
システムから出力される定型フォーマットの出力物 (PDF、CSV、Excel等)

### 出力形式
| 形式 | 用途 | 生成ライブラリ |
|------|------|--------------|
| PDF | 印刷帳票、電子書類 | [例: Puppeteer / wkhtmltopdf / PDFKit] |
| CSV | データエクスポート | 標準ライブラリ |
| Excel | データ分析用 | [例: ExcelJS / xlsx] |

### ファイル命名規則
- パターン: `{帳票種別}_{YYYYMMDD}_{連番}.{拡張子}`
- 例: `invoice_20240101_001.pdf`

### 保存・管理
| 項目 | 内容 |
|------|------|
| 保存先 | S3バケット / ストレージサービス |
| 保存期間 | 帳票種別により異なる (請求書: 7年、レポート: 1年等) |
| アクセス制御 | 署名付きURL (有効期限7日) |

---

## 2. 帳票一覧

| 帳票ID | 帳票名 | 出力形式 | 出力タイミング | 出力権限 | 保存期間 |
|-------|-------|---------|--------------|---------|---------|
| R001 | 請求書 | PDF | 月末バッチ / 手動 | admin, billing | 7年 |
| R002 | 納品書 | PDF | 出荷時自動 | admin, shipping | 5年 |
| R003 | ユーザー一覧 | CSV | 手動 | admin | 出力後削除 |
| R004 | 注文一覧 | CSV | 手動 | admin | 出力後削除 |
| R005 | 月次売上レポート | PDF | 毎月1日バッチ | admin | 1年 |

---

## 3. 帳票詳細設計

### 3.1 R001: 請求書 (PDF)

**基本情報**
| 項目 | 内容 |
|------|------|
| 帳票ID | R001 |
| 出力形式 | PDF (A4縦) |
| 出力タイミング | 月末23:00バッチ実行 / 管理画面から手動出力 |
| 出力権限 | admin, billing |
| 保存期間 | 7年 (法定保存期間) |
| API | `POST /api/v1/reports/invoices/{invoiceId}` |

**レイアウト**
```
┌────────────────────────────────────┐
│           請求書                    │
│                                    │
│  請求No: INV-2024-001              │
│  請求日: 2024年1月31日              │
│  支払期限: 2024年2月28日            │
│                                    │
│  ○○株式会社 御中                   │
│                                    │
│  ご請求金額: ¥110,000 (税込)       │
│                                    │
├────────────────────────────────────┤
│  明細                              │
├──┬──────────┬────┬────┬────────┤
│No│品目        │単価  │数量  │金額    │
├──┼──────────┼────┼────┼────────┤
│1 │サービス料  │10,000│  8  │ 80,000│
│2 │オプション料│ 5,000│  4  │ 20,000│
├──┴──────────┴────┴────┴────────┤
│                  小計: ¥100,000   │
│                  消費税: ¥10,000   │
│                  合計: ¥110,000   │
├────────────────────────────────────┤
│  振込先:                           │
│  ○○銀行 △△支店 普通 1234567     │
│  株式会社XXX                       │
│                                    │
│  お問い合わせ: billing@example.com │
└────────────────────────────────────┘
```

**データソース**
```sql
-- 請求書ヘッダー
SELECT
    i.id, i.invoice_number, i.invoice_date, i.due_date,
    i.total_amount, i.tax_amount,
    u.name AS customer_name, u.company_name, u.address
FROM invoices i
INNER JOIN users u ON i.user_id = u.id
WHERE i.id = :invoice_id;

-- 請求明細
SELECT
    line_number, item_name, unit_price, quantity, amount
FROM invoice_items
WHERE invoice_id = :invoice_id
ORDER BY line_number;

-- 自社情報
SELECT name, bank_name, branch_name, account_type, account_number, contact_email
FROM companies
WHERE id = 1;
```

**出力項目定義**
| セクション | 項目名 | データソース | 形式 | 必須 |
|-----------|-------|------------|------|------|
| ヘッダー | 請求番号 | invoices.invoice_number | INV-YYYY-NNN | ○ |
| ヘッダー | 請求日 | invoices.invoice_date | YYYY年MM月DD日 | ○ |
| ヘッダー | 支払期限 | invoices.due_date | YYYY年MM月DD日 | ○ |
| ヘッダー | 顧客名 | users.name / users.company_name | 文字列 | ○ |
| ヘッダー | 顧客住所 | users.address | 文字列 | × |
| 明細 | No | invoice_items.line_number | 数値 | ○ |
| 明細 | 品目 | invoice_items.item_name | 文字列 | ○ |
| 明細 | 単価 | invoice_items.unit_price | ¥#,##0 | ○ |
| 明細 | 数量 | invoice_items.quantity | #,##0 | ○ |
| 明細 | 金額 | invoice_items.amount | ¥#,##0 | ○ |
| 合計 | 小計 | SUM(amount) | ¥#,##0 | ○ |
| 合計 | 消費税 | invoices.tax_amount | ¥#,##0 | ○ |
| 合計 | 合計 | invoices.total_amount | ¥#,##0 | ○ |
| フッター | 振込先銀行 | companies.bank_name | 文字列 | ○ |
| フッター | 振込先支店 | companies.branch_name | 文字列 | ○ |
| フッター | 口座種別 | companies.account_type | 文字列 | ○ |
| フッター | 口座番号 | companies.account_number | 文字列 | ○ |
| フッター | 会社名 | companies.name | 文字列 | ○ |
| フッター | お問い合わせ先 | companies.contact_email | メール | ○ |

**処理フロー**
1. APIリクエスト受信 (invoiceId指定)
2. 請求データ取得 (ヘッダー + 明細 + 自社情報)
3. データ検証 (存在チェック、権限チェック)
4. HTMLテンプレートにデータバインド
5. PDF生成 (Puppeteer等)
6. ファイル名生成: `invoice_{invoice_number}_{YYYYMMDD}.pdf`
7. S3にアップロード: `s3://bucket/invoices/YYYY/MM/`
8. 署名付きURLを返却

**エラーハンドリング**
| エラー | 対処 |
|-------|------|
| 請求データ未存在 | 404エラー |
| 権限不足 | 403エラー |
| PDF生成失敗 | 3回リトライ → 失敗時は500エラー + ログ |
| S3アップロード失敗 | 3回リトライ → 失敗時は500エラー + ログ |

---

### 3.2 R002: 納品書 (PDF)

**基本情報**
| 項目 | 内容 |
|------|------|
| 帳票ID | R002 |
| 出力形式 | PDF (A4縦) |
| 出力タイミング | 出荷ステータス更新時自動生成 |
| 出力権限 | admin, shipping |
| 保存期間 | 5年 |
| API | `POST /api/v1/reports/delivery-notes/{orderId}` |

**レイアウト** (請求書と類似、項目は「注文」ベース)

**データソース**
```sql
SELECT
    o.id, o.order_number, o.order_date,
    u.name AS customer_name, u.address,
    oi.product_name, oi.quantity, oi.unit_price
FROM orders o
INNER JOIN users u ON o.user_id = u.id
INNER JOIN order_items oi ON o.id = oi.order_id
WHERE o.id = :order_id;
```

---

### 3.3 R003: ユーザー一覧 (CSV)

**基本情報**
| 項目 | 内容 |
|------|------|
| 帳票ID | R003 |
| 出力形式 | CSV (UTF-8 BOM付き) |
| 出力タイミング | 管理画面から手動出力 |
| 出力権限 | admin |
| 保存期間 | 出力後削除 (ダウンロードのみ) |
| API | `GET /api/v1/reports/users.csv` |

**データソース**
```sql
SELECT
    id, email, name, role, status, created_at, updated_at
FROM users
WHERE deleted_at IS NULL
ORDER BY id;
```

**CSV形式**
```csv
ID,メールアドレス,氏名,ロール,ステータス,作成日時,更新日時
1,user1@example.com,山田太郎,admin,active,2024-01-01 00:00:00,2024-01-01 00:00:00
2,user2@example.com,佐藤花子,user,active,2024-01-02 00:00:00,2024-01-02 00:00:00
```

**ファイル名**: `users_export_{YYYYMMDDHHMMSS}.csv`

**処理フロー**
1. APIリクエスト受信
2. ユーザーデータ取得 (deleted_at IS NULL)
3. CSV生成 (ヘッダー行 + データ行)
4. レスポンスとして直接ダウンロード返却 (S3保存なし)

---

### 3.4 R004: 注文一覧 (CSV)

**基本情報**
| 項目 | 内容 |
|------|------|
| 帳票ID | R004 |
| 出力形式 | CSV (UTF-8 BOM付き) |
| 出力タイミング | 管理画面から手動出力 |
| 出力権限 | admin |
| 保存期間 | 出力後削除 (ダウンロードのみ) |
| API | `GET /api/v1/reports/orders.csv?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD` |

**データソース**
```sql
SELECT
    o.id, o.order_number, o.order_date, o.total_amount, o.status,
    u.name AS customer_name, u.email AS customer_email
FROM orders o
INNER JOIN users u ON o.user_id = u.id
WHERE o.order_date BETWEEN :start_date AND :end_date
  AND o.deleted_at IS NULL
ORDER BY o.order_date DESC, o.id DESC;
```

**CSV形式**
```csv
注文ID,注文番号,注文日,顧客名,顧客メール,金額,ステータス
1,ORD-20240101-0001,2024-01-01,山田太郎,user1@example.com,10000,delivered
2,ORD-20240102-0002,2024-01-02,佐藤花子,user2@example.com,5000,shipped
```

**ファイル名**: `orders_export_{YYYYMMDD}_{YYYYMMDD}.csv`

---

### 3.5 R005: 月次売上レポート (PDF)

**基本情報**
| 項目 | 内容 |
|------|------|
| 帳票ID | R005 |
| 出力形式 | PDF (A4縦) |
| 出力タイミング | 毎月1日 01:00バッチ実行 (前月分) |
| 出力権限 | admin |
| 保存期間 | 1年 |
| API | `POST /api/v1/reports/monthly-sales/{YYYY}/{MM}` |

**レイアウト**
```
┌────────────────────────────────────┐
│      月次売上レポート               │
│      2024年1月                     │
├────────────────────────────────────┤
│  ■ サマリー                        │
│  売上合計: ¥1,234,567              │
│  注文件数: 123件                   │
│  平均注文額: ¥10,037               │
│                                    │
│  ■ 日別売上推移                    │
│  [グラフまたは表]                  │
│                                    │
│  ■ カテゴリ別売上                  │
│  カテゴリA: ¥500,000 (40%)        │
│  カテゴリB: ¥400,000 (32%)        │
│  カテゴリC: ¥334,567 (27%)        │
│                                    │
│  ■ トップ10商品                    │
│  1. 商品A - ¥100,000              │
│  2. 商品B - ¥80,000               │
│  ...                              │
└────────────────────────────────────┘
```

**データソース**
```sql
-- サマリー
SELECT
    COUNT(*) AS order_count,
    SUM(total_amount) AS total_sales,
    AVG(total_amount) AS avg_order_amount
FROM orders
WHERE order_date BETWEEN :start_date AND :end_date
  AND status IN ('delivered', 'shipped')
  AND deleted_at IS NULL;

-- 日別売上
SELECT
    order_date, SUM(total_amount) AS daily_sales
FROM orders
WHERE order_date BETWEEN :start_date AND :end_date
  AND status IN ('delivered', 'shipped')
  AND deleted_at IS NULL
GROUP BY order_date
ORDER BY order_date;

-- トップ10商品
SELECT
    p.name, SUM(oi.amount) AS product_sales
FROM order_items oi
INNER JOIN products p ON oi.product_id = p.id
INNER JOIN orders o ON oi.order_id = o.id
WHERE o.order_date BETWEEN :start_date AND :end_date
  AND o.status IN ('delivered', 'shipped')
  AND o.deleted_at IS NULL
GROUP BY p.id, p.name
ORDER BY product_sales DESC
LIMIT 10;
```

---

## 4. 帳票生成API共通仕様

### リクエスト形式
```
POST /api/v1/reports/{reportType}/{resourceId}
Authorization: Bearer {token}
```

### レスポンス形式
```json
{
  "reportId": "R001",
  "fileUrl": "https://storage.example.com/reports/invoice_20240101_001.pdf",
  "fileName": "invoice_20240101_001.pdf",
  "generatedAt": "2024-01-01T12:00:00Z",
  "expiresAt": "2024-01-08T12:00:00Z"
}
```

### エラーレスポンス
| HTTPステータス | エラーコード | 説明 |
|--------------|------------|------|
| 404 | RESOURCE_NOT_FOUND | 帳票生成対象データが存在しない |
| 403 | FORBIDDEN | 権限不足 |
| 500 | REPORT_GENERATION_FAILED | 帳票生成失敗 |

---

## 5. パフォーマンス

### 生成時間目標
| 帳票種別 | 目標時間 |
|---------|---------|
| PDF (1件) | 3秒以内 |
| CSV (1000件) | 5秒以内 |
| バッチ (100件) | 5分以内 |

### 最適化手法
- SQLクエリのインデックス活用
- テンプレートキャッシュ (HTMLテンプレート)
- 非同期処理 (大量生成時はジョブキューで処理)

---

## 6. セキュリティ

### アクセス制御
- ロール制御: adminのみ出力可、または本人のみ
- 署名付きURL: 有効期限7日、ワンタイムトークン

### 個人情報保護
- ファイル名に個人情報を含めない
- 保存期間経過後は自動削除 (S3ライフサイクルポリシー)

---

## 7. 重要な設計判断

### PDF生成ライブラリ選定
- **Puppeteer**: Chromiumベース、HTMLから高品質PDF生成
- メリット: CSSサポート豊富、日本語フォント対応
- デメリット: メモリ消費大、生成時間やや遅い

### CSV文字コード
- **UTF-8 BOM付き**: Excelでの文字化け防止
- 改行コード: CRLF (Windows互換)

### 非同期処理
- 大量帳票生成 (月次バッチ等) はジョブキュー (BullMQ等) で非同期処理
- 進捗状況をDBに記録、ユーザーに通知
