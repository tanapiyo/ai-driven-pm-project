# 運用設計書

## 1. 運用方針

### 運用目標
| 項目 | 目標値 |
|------|-------|
| 稼働率 | 99.9% (年間ダウンタイム8.76時間以内) |
| レスポンスタイム | 平均500ms以内 |
| エラー率 | 0.1%以下 |

### 運用体制
| 役割 | 担当 | 対応時間 |
|------|------|---------|
| 運用責任者 | [氏名] | 平日9:00-18:00 |
| 開発担当者 | [氏名] | 平日9:00-18:00 |
| 緊急連絡先 | [電話/Slack] | 24時間365日 |

### サービス提供時間
- **稼働時間**: 24時間365日
- **メンテナンス**: 毎月第2日曜日 2:00-4:00 (計画メンテナンス)

---

## 2. 監視

### 監視項目
| 対象 | 監視項目 | 正常範囲 | 警告 | 異常 | 監視間隔 |
|------|---------|---------|------|------|---------|
| Webサーバー | CPU使用率 | 0-60% | 70% | 85% | 1分 |
| Webサーバー | メモリ使用率 | 0-70% | 80% | 90% | 1分 |
| APIサーバー | CPU使用率 | 0-60% | 70% | 85% | 1分 |
| APIサーバー | メモリ使用率 | 0-70% | 80% | 90% | 1分 |
| DB | CPU使用率 | 0-60% | 70% | 85% | 1分 |
| DB | 接続数 | 0-80 | 90 | 100 | 1分 |
| API | レスポンスタイム | 0-300ms | 500ms | 1000ms | 1分 |
| API | エラー率 | 0-0.05% | 0.1% | 1% | 1分 |

### アラート通知
| レベル | 通知先 | 通知方法 | タイミング |
|-------|-------|---------|----------|
| 異常 (Critical) | 運用責任者、開発担当者 | Slack、メール | 即時 |
| 警告 (Warning) | 開発担当者 | Slack | 即時 |
| 情報 (Info) | Slack#monitoring | Slack | 即時 |

### 監視ツール
- **インフラ監視**: CloudWatch / Datadog
- **APM**: New Relic / Datadog APM
- **エラートラッキング**: Sentry
- **アラート管理**: PagerDuty / Slack

---

## 3. ログ管理

### ログ種別
| ログ種別 | 内容 | 出力先 | 保存期間 |
|---------|------|-------|---------|
| アクセスログ | HTTPリクエスト/レスポンス | CloudWatch Logs | 90日 |
| アプリログ | 処理ログ (INFO/DEBUG) | CloudWatch Logs | 90日 |
| エラーログ | エラー詳細、スタックトレース | CloudWatch Logs | 180日 |
| 監査ログ | 重要操作履歴 (ユーザー作成/削除等) | S3 | 1年 |

### ログフォーマット (JSON)
```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "level": "INFO",
  "message": "User login successful",
  "userId": 123,
  "requestId": "req-abc123",
  "ip": "192.168.1.1"
}
```

### ログレベル
| レベル | 用途 | 本番環境出力 |
|-------|------|------------|
| DEBUG | デバッグ情報 | × |
| INFO | 通常の動作情報 | ○ |
| WARNING | 警告 (処理継続) | ○ |
| ERROR | エラー (処理失敗) | ○ |
| CRITICAL | 致命的エラー | ○ |

---

## 4. バックアップ・リストア

### バックアップ方針
| 対象 | 方式 | 頻度 | 世代管理 | 保存先 | 保存期間 |
|------|------|------|---------|-------|---------|
| PostgreSQL | フルバックアップ | 日次 (深夜2:00) | 30世代 | S3 | 30日 |
| PostgreSQL | 増分バックアップ | 1時間毎 | 24世代 | S3 | 24時間 |
| S3ファイル | バージョニング | リアルタイム | - | S3 | 30日 |

### バックアップ手順
```bash
# PostgreSQLフルバックアップ
pg_dump -h ${DB_HOST} -U ${DB_USER} ${DB_NAME} | gzip > backup_$(date +%Y%m%d).sql.gz
aws s3 cp backup_$(date +%Y%m%d).sql.gz s3://bucket/backups/db/$(date +%Y)/$(date +%m)/
```

### リストア手順
```bash
# PostgreSQLリストア
aws s3 cp s3://bucket/backups/db/2024/01/backup_20240101.sql.gz .
gunzip backup_20240101.sql.gz
psql -h ${DB_HOST} -U ${DB_USER} ${DB_NAME} < backup_20240101.sql
```

### RPO/RTO
| 項目 | 目標値 |
|------|-------|
| RPO (復旧時点目標) | 1時間 |
| RTO (復旧時間目標) | 4時間 |

---

## 5. デプロイ・リリース

### デプロイフロー
```
1. コードレビュー (GitHub PR)
2. マージ → main/release ブランチ
3. CI実行 (ビルド、テスト)
4. ステージング環境デプロイ (自動)
5. 動作確認 (手動)
6. 本番環境デプロイ (手動承認)
```

### デプロイ方式
| 環境 | デプロイ方式 | トリガー | 承認 |
|------|-----------|---------|------|
| 開発環境 | 自動 | mainブランチマージ時 | 不要 |
| ステージング環境 | 自動 | releaseブランチ作成時 | 不要 |
| 本番環境 | 手動 | リリース予定日時 | 運用責任者 |

### リリーススケジュール
| リリース種別 | 頻度 | タイミング |
|------------|------|-----------|
| マイナーリリース | 月1回 | 毎月第2火曜日 |
| パッチリリース | 随時 | 緊急バグ修正時 |

### ロールバック手順
1. 問題検知 → 運用責任者判断
2. 前バージョンへ切り戻し (5分以内)
3. 動作確認
4. 原因調査・対策

---

## 6. バッチ処理

### バッチ一覧
| バッチID | バッチ名 | 実行タイミング | 実行時間 | 処理内容 | 失敗時の対応 |
|---------|---------|--------------|---------|---------|------------|
| B001 | DBバックアップ | 日次 | 深夜2:00 | フルバックアップ | 再実行、アラート |
| B002 | ログクリーンアップ | 日次 | 深夜3:00 | 古いログ削除 | 翌日再実行 |
| B003 | 月次請求書生成 | 月次 | 月末23:00 | 請求書PDF生成 | 手動再実行 |
| B004 | データ集計 | 日次 | 深夜4:00 | 統計データ集計 | 再実行 |

### バッチ実行方式
- **スケジューラー**: CloudWatch Events / Cron
- **リトライ**: 失敗時3回まで自動リトライ (間隔: 5分、15分、30分)
- **監視**: 実行開始・終了ログ、実行時間監視

---

## 7. 障害対応

### 障害レベル定義
| レベル | 定義 | 対応時間 |
|-------|------|---------|
| Critical | サービス全停止 | 即時対応 (1時間以内復旧) |
| High | 主要機能停止 | 1時間以内対応 (4時間以内復旧) |
| Medium | 一部機能停止 | 4時間以内対応 |
| Low | 軽微な不具合 | 1営業日以内対応 |

### 障害対応フロー
```
1. 障害検知 (監視アラート or ユーザー報告)
2. 一次切り分け (ログ確認、状況把握)
3. 関係者通知 (Slack)
4. 原因調査
5. 暫定対応 (ロールバック、サービス再起動等)
6. 恒久対応 (バグ修正、リリース)
7. 報告書作成
8. 再発防止策実施
```

### 主要障害パターンと対処
| 障害パターン | 原因 | 対処 |
|------------|------|------|
| Webサーバーダウン | プロセス停止 | プロセス再起動 |
| DBサーバーダウン | 接続不可 | DBサーバー再起動、フェイルオーバー |
| ディスク容量不足 | ログ肥大化 | ログクリーンアップ、ディスク拡張 |
| APIレスポンス遅延 | 高負荷 | スケールアウト、キャッシュ有効化 |
| エラー率急増 | バグ混入 | ロールバック |

---

## 8. セキュリティ運用

### 脆弱性管理
| 項目 | 頻度 | 内容 |
|------|------|------|
| 脆弱性スキャン | 週次 | OSパッケージ、ライブラリのCVEチェック |
| セキュリティパッチ適用 | 月次 | 脆弱性パッチ適用 |
| ペネトレーションテスト | 年次 | 外部専門家による侵入テスト |

### アクセス管理
- **アクセス権限レビュー**: 四半期毎
- **退職者アカウント削除**: 即日
- **MFA**: 本番環境アクセスは必須
- **パスワードポリシー**: 最小12文字、英数字記号混在、90日毎変更

### 監査ログレビュー
- 重要操作 (ユーザー作成/削除、権限変更) を週次でレビュー
- 不審なアクセスパターンの検知

---

## 9. キャパシティ管理

### リソース使用状況
| リソース | 現在使用量 | 上限 | 使用率 | 次回拡張予定 |
|---------|----------|------|-------|------------|
| Webサーバー台数 | 2台 | 10台 | 20% | 使用率70%到達時 |
| DBストレージ | 100GB | 500GB | 20% | 使用率70%到達時 |

### キャパシティ予測
- 月次でリソース使用率をレビュー
- トレンド分析により拡張時期を予測

### スケーリング
| トリガー | アクション | タイミング |
|---------|----------|-----------|
| CPU使用率70%が30分継続 | Webサーバー/APIサーバー1台追加 | 自動 (Auto Scaling) |
| ストレージ使用率70% | ストレージ拡張 | 手動 (計画的) |

---

## 10. 定期作業

### 日次作業
| 作業項目 | 実施時間 | 担当者 | 内容 |
|---------|---------|-------|------|
| 監視ダッシュボード確認 | 9:00 | 開発担当者 | 前日のアラート、エラーログ確認 |
| バックアップ成功確認 | 9:30 | 開発担当者 | バックアップログ確認 |

### 週次作業
| 作業項目 | 実施日時 | 担当者 | 内容 |
|---------|---------|-------|------|
| エラーログ分析 | 毎週月曜10:00 | 開発担当者 | 週次エラー傾向分析 |
| 脆弱性スキャン | 毎週水曜深夜 | 自動 | CVEチェック |

### 月次作業
| 作業項目 | 実施日 | 担当者 | 内容 |
|---------|-------|-------|------|
| バックアップリストアテスト | 第1月曜 | 開発担当者 | ステージング環境でリストア |
| セキュリティパッチ適用 | 第2火曜 | 開発担当者 | OSパッチ適用 |
| キャパシティレビュー | 月初 | 運用責任者 | リソース使用状況レビュー |

---

## 11. コスト管理

### コスト監視
| 項目 | 月額予算 | アラートしきい値 | 確認頻度 |
|------|---------|---------------|---------|
| インフラコスト全体 | ¥500,000 | ¥550,000 (110%) | 日次 |
| EC2 | ¥200,000 | ¥220,000 | 日次 |
| RDS | ¥150,000 | ¥165,000 | 日次 |
| S3 | ¥50,000 | ¥55,000 | 週次 |

### コスト最適化
- Auto Scaling: 夜間・休日は最小台数に自動縮小
- リザーブドインスタンス: DB・Redis は予約購入
- S3ライフサイクル: 古いファイルは自動でGlacierへ

---

## 12. ドキュメント管理

### 運用ドキュメント一覧
| ドキュメント名 | 更新頻度 | 管理場所 |
|--------------|---------|---------|
| 運用手順書 | 変更時 | Wiki/Git |
| 障害対応手順書 | 変更時 | Wiki/Git |
| システム構成図 | 変更時 | Wiki/Git |
| FAQ | 随時 | Wiki |

### ドキュメント更新
- システム変更時に関連ドキュメントも更新
- 四半期毎にドキュメントレビュー

---

## 13. 重要な設計判断

### 監視戦略
- **メトリクス監視**: CPU/メモリ/ディスク/ネットワーク
- **APM**: API レスポンスタイム、エラー率
- **ログ集約**: CloudWatch Logs で一元管理

### バックアップ戦略
- **RPO 1時間**: 1時間毎の増分バックアップ
- **RTO 4時間**: 手順書整備、定期訓練

### 障害対応
- **即時検知**: 監視アラートで1分以内に検知
- **迅速復旧**: ロールバック手順の自動化
- **再発防止**: 障害後は必ず報告書作成、再発防止策実施
