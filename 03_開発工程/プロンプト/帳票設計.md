# 帳票設計作成プロンプト

## 目的
要件定義書の内容を基に、システムから出力される印刷物やファイル（PDF、CSV等）の帳票設計書を作成します。

## インプット
以下のドキュメントを読み込んでください：
1. **要件定義書**: `[要件定義書のパス]`
2. **DB設計書**: `03_開発工程/テンプレート/DB設計.md`
3. **API設計書**: `03_開発工程/テンプレート/API設計.md`（帳票出力APIの設計に使用）

## 出力指示
`03_開発工程/テンプレート/帳票設計.md` のテンプレートを使用して、帳票設計書を作成してください。

## 作成ガイドライン

### 1. 要件定義書の分析
まず、以下の情報を要件定義書から抽出してください：

#### 1.1 帳票要件の特定
- **出力帳票一覧**: 要件に記載された帳票（請求書、領収書、レポート等）
- **出力タイミング**: いつ出力するか（バッチ、手動、イベント駆動）
- **出力形式**: PDF、CSV、Excel等
- **用途**: 誰が何のために使うか
- **法的要件**: 保存期間、記載必須項目

#### 1.2 データ要件の確認
- **出力項目**: 帳票に表示する情報
- **データソース**: DB設計書のどのテーブルから取得するか
- **集計・計算**: 合計、平均などの計算ロジック

#### 1.3 非機能要件の確認
- **性能要件**: 生成時間の目標
- **セキュリティ要件**: アクセス制御、個人情報保護
- **運用要件**: バッチ処理、保存期間、バックアップ

### 2. 帳票設計の進め方

#### ステップ1: 帳票一覧の作成
1. 要件定義書から全帳票を洗い出し
2. 帳票IDを採番（R001, R002...）
3. 各帳票の基本情報を整理（出力形式、タイミング、権限）

#### ステップ2: 帳票詳細設計
各帳票について以下を設計：
1. **レイアウト設計**: ヘッダー、明細、フッターの配置
2. **データソース定義**: 取得元テーブル、SQL
3. **出力項目定義**: 各項目のデータソース、形式
4. **生成ロジック**: 処理フロー
5. **バリデーション**: データ整合性チェック

#### ステップ3: 帳票出力処理の設計
1. **API設計**: 帳票出力API
2. **バッチ処理**: 定期実行する帳票
3. **テンプレート管理**: HTMLテンプレート等の管理方法

### 3. 各セクションの作成指示

#### 3.1 帳票設計方針 (セクション3)
- **帳票種別**: 印刷帳票、PDF、CSV等の分類
- **出力形式方針**: 使用ライブラリ、用紙サイズ、フォント
- **命名規則**: ファイル名、テンプレート名
- **保存・管理方針**: 保存場所、保存期間、アクセス制御

#### 3.2 帳票一覧 (セクション4)
全帳票を一覧表で整理：
- 帳票ID、帳票名、出力形式
- 用途、出力タイミング、出力権限
- 要件定義書との対応を明記

#### 3.3 帳票詳細設計 (セクション5)
各帳票について以下を詳細に定義：

**基本情報**:
- 帳票ID、帳票名、出力形式、用紙サイズ
- 用途、出力タイミング、出力権限
- 保存期間、再出力可否

**レイアウト設計**:
- テキストベースまたは図で帳票のレイアウトを表現
- ヘッダー、明細、フッターの配置
- 複数ページになる場合のページ分割位置

**データソース**:
- 取得元テーブル一覧
- SQL概要（主要なSELECT文）
- 結合条件

**出力項目定義**:
- 各項目のデータソース（テーブル.カラム）
- 表示形式（日付、金額、数値等のフォーマット）
- 必須/任意

**生成ロジック**:
1. データ取得
2. データ検証
3. テンプレートバインド
4. PDF/CSV生成
5. 保存
6. レスポンス返却

**バリデーション**:
- データ存在チェック
- 金額整合性チェック
- 権限チェック

**エラーハンドリング**:
- エラーケースと対処方法
- リトライポリシー

#### 3.4 帳票テンプレート管理 (セクション6)
- **テンプレート形式**: HTML、Excel等
- **テンプレートファイル配置**: ディレクトリ構造
- **テンプレート変数**: 使用する変数の定義

PDF帳票の場合、HTMLテンプレートの例を記載：
```html
<div class="invoice">
  <h1>{{title}}</h1>
  <p>{{invoiceNumber}}</p>
  {{#each items}}
  <div>{{this.itemName}}: {{this.amount}}</div>
  {{/each}}
</div>
```

#### 3.5 帳票出力処理 (セクション7)
- **出力フロー**: リクエスト→データ取得→生成→保存→レスポンス
- **API設計**: 帳票出力API（POST /api/v1/reports/{reportId}/generate）
- **バッチ処理**: 定期実行する帳票のバッチ設計

#### 3.6 パフォーマンス (セクション8)
- **生成時間目標**: 性能要件から設定
- **最適化方針**: SQLチューニング、キャッシュ、非同期処理

#### 3.7 セキュリティ (セクション9)
- **アクセス制御**: ロール別の出力権限、本人確認
- **ダウンロードURL**: 署名付きURL、有効期限
- **個人情報保護**: ファイル名、ログ出力の注意

#### 3.8 エラーハンドリング (セクション10)
- エラーケース（データ不存在、権限不足、生成失敗等）
- リトライポリシー

#### 3.9 運用 (セクション12)
- **監視項目**: 生成失敗率、生成時間、ストレージ使用量
- **ログ出力**: 生成ログ、エラーログ
- **バックアップ**: 帳票ファイル、テンプレートのバックアップ

### 4. 帳票設計の重要ポイント

#### 4.1 レイアウト設計
- **用紙サイズ**: A4が標準
- **余白**: 印刷時の切れを考慮して10mm程度
- **フォント**: 読みやすいサイズ（本文10-12pt）
- **ページ分割**: 明細が多い場合の改ページ位置
- **ヘッダー/フッター**: 全ページ共通、ページ番号

#### 4.2 データソース設計
- **DB設計との整合**: テーブル・カラムが存在するか確認
- **結合**: 必要なテーブルを適切に結合
- **ソート順**: 明細の表示順を定義
- **集計**: 合計、小計の計算ロジック

#### 4.3 出力形式別の考慮事項

**PDF帳票**:
- HTMLテンプレート + CSS
- PDF生成ライブラリ（wkhtmltopdf, Puppeteer等）
- 日本語フォント対応
- 印刷時のレイアウト崩れ防止

**CSV/Excel**:
- 文字コード（UTF-8 BOM付き推奨）
- ヘッダー行
- データ型（数値、日付の形式）
- 大量データの場合はストリーミング出力

#### 4.4 法的要件への対応
- **請求書・領収書**: 保存期間7年（税法）
- **記載必須項目**: 発行日、取引内容、金額、宛名、発行者
- **電子帳簿保存法**: 要件を満たす形式で保存

#### 4.5 パフォーマンス考慮
- **大量データ**: ページネーション、ストリーミング
- **複雑な集計**: 事前に集計テーブルを用意
- **並列生成**: 複数帳票を並列で生成（バッチ処理）

#### 4.6 ユーザビリティ
- **わかりやすいレイアウト**: 重要情報を目立たせる
- **エラーメッセージ**: ユーザーにわかりやすい説明
- **再出力**: 過去の帳票を再度出力可能に

### 5. チェックリスト
作成後、以下を確認してください：

**帳票一覧**
- [ ] 要件定義書の全帳票が一覧に含まれている
- [ ] 各帳票にIDが採番されている
- [ ] 出力タイミング、権限が明確である

**帳票詳細設計**
- [ ] 全帳票の詳細設計が記載されている
- [ ] レイアウトが視覚的にわかりやすい
- [ ] データソースが DB設計書と整合している
- [ ] 出力項目が全て定義されている
- [ ] バリデーションが適切である

**データソース**
- [ ] DB設計書のテーブル・カラムと対応している
- [ ] SQL文が実行可能である
- [ ] 集計ロジックが明確である

**出力形式**
- [ ] PDF: テンプレート形式、フォント、用紙サイズが定義されている
- [ ] CSV: 文字コード、ヘッダー、区切り文字が定義されている

**パフォーマンス**
- [ ] 生成時間目標が設定されている
- [ ] 大量データへの対応が考慮されている

**セキュリティ**
- [ ] アクセス制御が定義されている
- [ ] 個人情報保護が考慮されている
- [ ] ダウンロードURLの有効期限が設定されている

**運用**
- [ ] 監視項目が定義されている
- [ ] ログ出力が定義されている
- [ ] バックアップ方針が明確である
- [ ] 保存期間が法的要件を満たしている

**法的要件（該当する場合）**
- [ ] 請求書・領収書の必須項目が含まれている
- [ ] 保存期間が法定期間を満たしている
- [ ] 電子帳簿保存法の要件を満たしている

**ドキュメント**
- [ ] 各帳票の用途が明確である
- [ ] サンプル画像またはレイアウト図がある
- [ ] テンプレート変数が定義されている

## 出力形式
- テンプレートの構造を維持
- 各項目を過不足なく埋める
- レイアウトは図またはテキストで視覚的に表現
- SQL文は実行可能な形式で記載
- テンプレート例は実際に使用可能な形式で記載

## 記載時の注意事項

### 具体性
- 抽象的な表現を避け、具体的なレイアウト、項目、フォーマットを記載
- 例: ✗「適切なレイアウト」→ ✓「A4縦、ヘッダー20mm、本文140mm、フッター20mm」

### 要件との紐付け
- 各帳票が要件定義書のどの機能から導出されたか明記
- 例: 「要件定義書3.5の請求機能で使用」

### DB設計との整合性
- データソースがDB設計書のテーブル・カラムと一致
- 存在しないテーブル・カラムを参照しない

### 実装可能性
- 選定した技術スタックで実装可能
- 一般的なライブラリ・ツールを使用

### 一貫性
- 命名規則の統一（帳票ID、ファイル名）
- 日付・金額フォーマットの統一
- エラーハンドリングの統一

## 最終出力先
`03_開発工程/帳票設計.md` に保存してください。
