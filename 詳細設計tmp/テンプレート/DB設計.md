# データベース設計書

## 1. 文書管理情報
- **作成日**: YYYY/MM/DD
- **最終更新日**: YYYY/MM/DD
- **作成者**: [作成者名]
- **バージョン**: 1.0
- **承認者**: [承認者名]

## 2. 概要
### 2.1 目的
[このデータベース設計書の目的を記載]

### 2.2 対象システム
[対象となるシステム名を記載]

### 2.3 参照ドキュメント
- 要件定義書
- システム構成図
- [その他関連ドキュメント]

## 3. データベース全体方針
### 3.1 DBMS選定
| 項目 | 内容 |
|------|------|
| DBMS種類 | [例: PostgreSQL / MySQL / Oracle] |
| バージョン | [例: 15.2] |
| 選定理由 | [要件との関連性を明記] |

### 3.2 命名規則
| 対象 | 規則 | 例 |
|------|------|-----|
| テーブル名 | [例: 複数形・スネークケース] | users, order_items |
| カラム名 | [例: スネークケース] | user_id, created_at |
| インデックス名 | [例: idx_{テーブル名}_{カラム名}] | idx_users_email |
| 外部キー名 | [例: fk_{テーブル名}_{参照先テーブル名}] | fk_orders_users |
| シーケンス名 | [例: seq_{テーブル名}] | seq_users |

### 3.3 データ型使用方針
| データ種別 | 使用するデータ型 | 備考 |
|-----------|----------------|------|
| 主キー | [例: BIGSERIAL] | 自動採番 |
| 文字列（短） | [例: VARCHAR(255)] | |
| 文字列（長） | [例: TEXT] | |
| 日時 | [例: TIMESTAMP WITH TIME ZONE] | UTC保存 |
| 金額 | [例: NUMERIC(10,2)] | 精度保証 |
| 論理値 | [例: BOOLEAN] | |
| 列挙型 | [例: VARCHAR or ENUM] | |

### 3.4 共通カラム定義
全テーブルに設定する共通カラム：

| カラム名 | データ型 | NULL | デフォルト値 | 説明 |
|---------|---------|------|------------|------|
| id | BIGSERIAL | NOT NULL | - | 主キー |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |
| created_by | VARCHAR(100) | NULL | - | 作成者 |
| updated_by | VARCHAR(100) | NULL | - | 更新者 |
| deleted_at | TIMESTAMP | NULL | - | 論理削除日時 |

## 4. ER図
### 4.1 概念ER図
```
[エンティティ間の関係を記載 - Mermaid ER図形式]
例:
erDiagram
    USERS ||--o{ ORDERS : places
    ORDERS ||--|{ ORDER_ITEMS : contains
    PRODUCTS ||--o{ ORDER_ITEMS : "ordered in"
```

### 4.2 論理ER図
```
[詳細な属性を含むER図を記載]
```

## 5. テーブル定義
### 5.1 テーブル一覧
| No | テーブル名 | 論理名 | 用途 | レコード件数見積 | 備考 |
|----|----------|-------|------|---------------|------|
| 1 | users | ユーザー | ユーザー情報管理 | 10,000 | |
| 2 | orders | 注文 | 注文情報管理 | 100,000 | |

### 5.2 テーブル詳細定義

#### 5.2.1 [テーブル名: users]
**テーブル概要**
| 項目 | 内容 |
|------|------|
| 論理名 | ユーザー |
| 物理名 | users |
| 用途 | システム利用ユーザーの情報を管理 |
| 想定件数 | 初期: 1,000件、年間増加: 5,000件 |

**カラム定義**
| No | カラム名 | 論理名 | データ型 | 桁数 | NULL | PK | FK | UK | デフォルト値 | 説明 | 備考 |
|----|---------|-------|---------|------|------|----|----|----|-----------|----|------|
| 1 | id | ユーザーID | BIGSERIAL | - | NOT NULL | ○ | | | | 主キー | 自動採番 |
| 2 | email | メールアドレス | VARCHAR | 255 | NOT NULL | | | ○ | | ログインID | |
| 3 | password_hash | パスワードハッシュ | VARCHAR | 255 | NOT NULL | | | | | 暗号化済み | bcrypt |
| 4 | name | 氏名 | VARCHAR | 100 | NOT NULL | | | | | | |
| 5 | role | 権限 | VARCHAR | 20 | NOT NULL | | | | 'user' | admin/user | |
| 6 | status | ステータス | VARCHAR | 20 | NOT NULL | | | | 'active' | active/inactive/suspended | |
| 7 | last_login_at | 最終ログイン日時 | TIMESTAMP | - | NULL | | | | | | |
| 8 | created_at | 作成日時 | TIMESTAMP | - | NOT NULL | | | | CURRENT_TIMESTAMP | | |
| 9 | updated_at | 更新日時 | TIMESTAMP | - | NOT NULL | | | | CURRENT_TIMESTAMP | | |
| 10 | deleted_at | 削除日時 | TIMESTAMP | - | NULL | | | | | 論理削除 | |

**インデックス定義**
| インデックス名 | 種類 | カラム | 目的 |
|-------------|------|-------|------|
| pk_users | PRIMARY KEY | id | 主キー |
| uk_users_email | UNIQUE | email | メールアドレス一意性 |
| idx_users_status | INDEX | status | ステータス検索 |
| idx_users_deleted_at | INDEX | deleted_at | 論理削除判定 |

**制約定義**
| 制約名 | 種類 | 対象カラム | 制約内容 |
|-------|------|----------|---------|
| chk_users_email | CHECK | email | メールアドレス形式チェック |
| chk_users_role | CHECK | role | role IN ('admin', 'user') |
| chk_users_status | CHECK | status | status IN ('active', 'inactive', 'suspended') |

**トリガー定義**
| トリガー名 | タイミング | イベント | 処理内容 |
|----------|----------|---------|---------|
| trg_users_updated_at | BEFORE UPDATE | UPDATE | updated_atを現在時刻に更新 |

---

#### 5.2.2 [テーブル名: orders]
**テーブル概要**
| 項目 | 内容 |
|------|------|
| 論理名 | 注文 |
| 物理名 | orders |
| 用途 | 注文情報を管理 |
| 想定件数 | 初期: 0件、年間増加: 50,000件 |

**カラム定義**
| No | カラム名 | 論理名 | データ型 | 桁数 | NULL | PK | FK | UK | デフォルト値 | 説明 | 備考 |
|----|---------|-------|---------|------|------|----|----|----|-----------|----|------|
| 1 | id | 注文ID | BIGSERIAL | - | NOT NULL | ○ | | | | 主キー | |
| 2 | user_id | ユーザーID | BIGINT | - | NOT NULL | | ○ | | | users.id参照 | |
| 3 | order_number | 注文番号 | VARCHAR | 50 | NOT NULL | | | ○ | | 採番ルール別途定義 | |
| 4 | order_date | 注文日 | DATE | - | NOT NULL | | | | | | |
| 5 | total_amount | 合計金額 | NUMERIC | 10,2 | NOT NULL | | | | | 税込金額 | |
| 6 | status | ステータス | VARCHAR | 20 | NOT NULL | | | | 'pending' | pending/confirmed/shipped/delivered/cancelled | |
| 7 | created_at | 作成日時 | TIMESTAMP | - | NOT NULL | | | | CURRENT_TIMESTAMP | | |
| 8 | updated_at | 更新日時 | TIMESTAMP | - | NOT NULL | | | | CURRENT_TIMESTAMP | | |
| 9 | deleted_at | 削除日時 | TIMESTAMP | - | NULL | | | | | 論理削除 | |

**インデックス定義**
| インデックス名 | 種類 | カラム | 目的 |
|-------------|------|-------|------|
| pk_orders | PRIMARY KEY | id | 主キー |
| uk_orders_order_number | UNIQUE | order_number | 注文番号一意性 |
| fk_orders_user_id | FOREIGN KEY | user_id | users.id参照 |
| idx_orders_user_id | INDEX | user_id | ユーザー別注文検索 |
| idx_orders_order_date | INDEX | order_date | 注文日検索 |
| idx_orders_status | INDEX | status | ステータス検索 |

**制約定義**
| 制約名 | 種類 | 対象カラム | 制約内容 |
|-------|------|----------|---------|
| fk_orders_users | FOREIGN KEY | user_id | REFERENCES users(id) ON DELETE RESTRICT |
| chk_orders_total_amount | CHECK | total_amount | total_amount >= 0 |
| chk_orders_status | CHECK | status | status IN ('pending', 'confirmed', 'shipped', 'delivered', 'cancelled') |

---

[他のテーブルも同様の形式で定義]

## 6. マスターデータ定義
### 6.1 マスターテーブル一覧
| No | テーブル名 | 論理名 | 更新頻度 | 件数 | 管理方法 |
|----|----------|-------|---------|------|---------|
| 1 | categories | カテゴリー | 月1回 | 100 | 画面から登録 |

### 6.2 初期データ定義
各マスターテーブルに投入する初期データを定義：

#### 6.2.1 [マスターテーブル名]
```sql
INSERT INTO categories (id, name, sort_order) VALUES
(1, '電化製品', 1),
(2, '書籍', 2),
(3, '食品', 3);
```

## 7. ビュー定義
### 7.1 ビュー一覧
| No | ビュー名 | 論理名 | 用途 | 備考 |
|----|---------|-------|------|------|
| 1 | v_active_users | 有効ユーザー | 削除されていないユーザー一覧 | |

### 7.2 ビュー詳細定義

#### 7.2.1 [ビュー名: v_active_users]
**ビュー概要**
| 項目 | 内容 |
|------|------|
| 論理名 | 有効ユーザー |
| 物理名 | v_active_users |
| 用途 | 論理削除されていないアクティブなユーザー一覧を提供 |

**SQL定義**
```sql
CREATE VIEW v_active_users AS
SELECT
    id,
    email,
    name,
    role,
    status,
    last_login_at,
    created_at,
    updated_at
FROM users
WHERE deleted_at IS NULL
  AND status = 'active';
```

## 8. インデックス戦略
### 8.1 インデックス設計方針
- 主キーには自動的にインデックスを作成
- 外部キーカラムにはインデックスを作成
- WHERE句で頻繁に使用されるカラムにインデックスを作成
- 複合インデックスは検索条件の組み合わせを考慮
- インデックス数は適切に抑制（INSERT/UPDATE性能とのバランス）

### 8.2 複合インデックス定義
| テーブル名 | インデックス名 | カラム | 目的 | 備考 |
|-----------|-------------|-------|------|------|
| orders | idx_orders_user_status | user_id, status | ユーザー別ステータス検索 | |

## 9. パーティショニング
### 9.1 パーティショニング対象テーブル
| テーブル名 | パーティション方式 | パーティションキー | 理由 |
|-----------|-----------------|------------------|------|
| orders | レンジパーティション | order_date | 年次でのデータアーカイブ |

### 9.2 パーティション定義例
```sql
-- [パーティショニングの具体的なSQL定義]
```

## 10. データ容量見積
### 10.1 テーブル別容量見積
| テーブル名 | 1レコードサイズ | 初期件数 | 年間増加 | 保持期間 | 5年後想定件数 | 5年後想定容量 |
|-----------|--------------|---------|---------|---------|-------------|-------------|
| users | 500 byte | 1,000 | 5,000 | 永続 | 26,000 | 13 MB |
| orders | 300 byte | 0 | 50,000 | 5年 | 250,000 | 75 MB |

### 10.2 データベース全体容量
- **初期容量**: [計算結果] MB
- **5年後想定容量**: [計算結果] GB
- **推奨割り当て容量**: [余裕を持たせた値] GB

## 11. データ保持・削除ポリシー
### 11.1 データ保持期間
| テーブル名 | 保持期間 | 削除方式 | 削除タイミング | アーカイブ要否 |
|-----------|---------|---------|--------------|--------------|
| orders | 5年 | 物理削除 | 毎月1日バッチ | あり |
| logs | 3ヶ月 | 物理削除 | 日次バッチ | なし |

### 11.2 論理削除運用
- 論理削除対象: ユーザーマスター、重要トランザクションデータ
- 論理削除カラム: deleted_at (NULL=有効、値あり=削除済み)
- 物理削除への移行: 論理削除から1年後にバッチで物理削除

## 12. セキュリティ設計
### 12.1 アクセス制御
| ロール名 | 権限 | 対象テーブル | 備考 |
|---------|------|------------|------|
| app_user | SELECT, INSERT, UPDATE | 全テーブル | アプリケーション用 |
| app_admin | SELECT, INSERT, UPDATE, DELETE | 全テーブル | 管理機能用 |
| readonly | SELECT | 全テーブル | レポート作成用 |

### 12.2 暗号化対応
| 対象 | 暗号化方式 | 対象カラム | 備考 |
|------|----------|-----------|------|
| パスワード | bcrypt | users.password_hash | アプリケーション層で実施 |
| 個人情報 | AES-256 | [該当カラム] | DB透過暗号化 |

### 12.3 監査ログ
- 対象操作: INSERT, UPDATE, DELETE
- 記録内容: 操作日時、操作者、操作内容、変更前後の値
- 保存先: audit_logsテーブル

## 13. バックアップ・リカバリ
### 13.1 バックアップ方針
| バックアップ種別 | 対象 | 頻度 | 保存期間 | 保存先 |
|---------------|------|------|---------|-------|
| フルバックアップ | DB全体 | 日次（深夜） | 30日 | S3 |
| 差分バックアップ | 更新データ | 1時間毎 | 7日 | S3 |
| トランザクションログ | WAL | リアルタイム | 7日 | S3 |

### 13.2 リカバリ手順
1. 最新のフルバックアップをリストア
2. 差分バックアップを適用
3. トランザクションログをリプレイ
4. データ整合性確認

## 14. パフォーマンス設計
### 14.1 スロークエリ対策
- スロークエリログ有効化
- 実行時間1秒以上のクエリを記録
- 定期的な分析とインデックス最適化

### 14.2 統計情報更新
- 自動VACUUM設定
- 統計情報の定期更新（週次）
- 大量データ投入後は手動でANALYZE実行

### 14.3 コネクションプール設定
| 設定項目 | 値 | 理由 |
|---------|-----|------|
| 最大接続数 | 100 | 同時接続想定数 |
| アイドルタイムアウト | 300秒 | リソース効率化 |

## 15. 移行計画
### 15.1 データ移行方針
[既存システムからの移行がある場合]
- 移行元システム: [システム名]
- 移行方式: [一括/段階的]
- 移行ツール: [使用ツール]
- データクレンジング方針: [重複削除、正規化など]

### 15.2 移行スケジュール
| フェーズ | 作業内容 | 期間 | 備考 |
|---------|---------|------|------|
| 準備 | スキーマ作成 | [期間] | |
| 検証 | テストデータ投入 | [期間] | |
| 本番移行 | 本番データ移行 | [期間] | |

## 16. 制約事項・前提条件
### 16.1 技術的制約
- [制約事項1]
- [制約事項2]

### 16.2 前提条件
- [前提条件1]
- [前提条件2]

## 17. 用語集
| 用語 | 説明 |
|------|------|
| 論理削除 | レコードを物理的に削除せず、フラグで削除状態を管理する方式 |
| [その他用語] | [説明] |

## 18. 補足資料
### 18.1 DDL生成スクリプト
```sql
-- [テーブル作成DDL]
```

### 18.2 サンプルクエリ
```sql
-- [よく使うクエリのサンプル]
```

## 19. 変更履歴
| 版数 | 変更日 | 変更者 | 変更内容 |
|------|-------|--------|---------|
| 1.0 | YYYY/MM/DD | [氏名] | 初版作成 |
