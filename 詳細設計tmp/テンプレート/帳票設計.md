# 帳票設計書

## 1. 文書管理情報
- **作成日**: YYYY/MM/DD
- **最終更新日**: YYYY/MM/DD
- **作成者**: [作成者名]
- **バージョン**: 1.0
- **承認者**: [承認者名]

## 2. 概要
### 2.1 目的
[この帳票設計書の目的を記載]

### 2.2 対象システム
[対象となるシステム名を記載]

### 2.3 参照ドキュメント
- 要件定義書
- DB設計書
- API設計書
- [その他関連ドキュメント]

## 3. 帳票設計方針
### 3.1 帳票の定義
帳票とは、システムから出力される印刷物、PDFファイル、CSVファイルなどの定型フォーマットの出力物を指します。

### 3.2 帳票種別
| 種別 | 説明 | 例 |
|------|------|-----|
| 印刷帳票 | 紙に印刷する帳票 | 請求書、納品書、領収書 |
| PDF帳票 | PDF形式で出力 | 月次レポート、契約書 |
| CSV/Excel | データ形式で出力 | データエクスポート、一覧表 |
| メール添付 | メールに添付して送信 | 注文確認書 |

### 3.3 出力形式方針
| 項目 | 内容 |
|------|------|
| PDF生成ライブラリ | [例: wkhtmltopdf / Puppeteer / ReportLab] |
| 用紙サイズ | A4（推奨）、A3、B5等 |
| 文字コード | UTF-8 |
| フォント | [例: Noto Sans JP（日本語対応）] |
| 画像形式 | PNG, JPG |

### 3.4 命名規則
| 対象 | 規則 | 例 |
|------|------|-----|
| 帳票ファイル名 | {帳票種別}_{YYYYMMDD}_{連番}.pdf | invoice_20240101_001.pdf |
| テンプレートファイル | {帳票ID}_template.html | R001_template.html |

### 3.5 保存・管理方針
| 項目 | 内容 |
|------|------|
| 保存場所 | [例: S3バケット / ファイルサーバー] |
| 保存期間 | [例: 請求書7年、レポート1年] |
| アクセス制御 | 本人・管理者のみ閲覧可能 |
| 再出力可否 | 可能（履歴として保存） |

## 4. 帳票一覧
### 4.1 帳票一覧表
| 帳票ID | 帳票名 | 出力形式 | 用途 | 出力タイミング | 出力権限 | 備考 |
|-------|-------|---------|------|--------------|---------|------|
| R001 | 請求書 | PDF | 顧客への請求 | 月末 | admin, billing | |
| R002 | 納品書 | PDF | 商品納品時 | 出荷時 | admin, shipping | |
| R003 | 領収書 | PDF | 支払い証明 | 入金確認後 | admin, billing | |
| R004 | ユーザー一覧 | CSV | データエクスポート | 手動 | admin | |
| R005 | 月次売上レポート | PDF | 経営分析 | 毎月1日 | admin | |

## 5. 帳票詳細設計

### 5.1 [帳票ID: R001 請求書]

#### 5.1.1 基本情報
| 項目 | 内容 |
|------|------|
| 帳票ID | R001 |
| 帳票名 | 請求書 |
| 出力形式 | PDF |
| 用紙サイズ | A4縦 |
| 用途 | 顧客への月次請求 |
| 出力タイミング | 毎月末日バッチ実行 / 手動出力可能 |
| 出力権限 | admin, billing |
| 保存期間 | 7年（法定保存期間） |
| 再出力 | 可能 |

#### 5.1.2 帳票レイアウト
```
┌────────────────────────────────────────┐
│                請求書                   │  ← ヘッダー
│                                        │
│  請求No: INV-2024-001                  │
│  請求日: 2024年1月31日                  │
│  支払期限: 2024年2月28日                │
│                                        │
│  ○○株式会社 御中                       │  ← 宛先情報
│                                        │
│  下記の通りご請求申し上げます。          │
│                                        │
│  ご請求金額: ¥100,000（税込）          │  ← 請求金額サマリー
│                                        │
├────────────────────────────────────────┤
│  明細                                  │  ← 明細ヘッダー
├────┬──────────┬────┬────┬────────┤
│No  │品目          │単価  │数量  │金額      │
├────┼──────────┼────┼────┼────────┤
│ 1  │サービス料    │10,000│  8  │  80,000  │  ← 明細行
│ 2  │オプション料  │ 5,000│  4  │  20,000  │
├────┴──────────┴────┴────┴────────┤
│                        小計: ¥100,000  │
│                        消費税: ¥10,000  │
│                        合計: ¥110,000  │  ← 合計
├────────────────────────────────────────┤
│  振込先:                               │  ← フッター
│  ○○銀行 △△支店 普通 1234567         │
│  株式会社XXX                           │
│                                        │
│  お問い合わせ: billing@example.com     │
└────────────────────────────────────────┘
```

#### 5.1.3 データソース
**取得元テーブル**
| テーブル名 | 用途 | 結合条件 |
|-----------|------|---------|
| invoices | 請求書ヘッダー情報 | - |
| invoice_items | 請求明細 | invoices.id = invoice_items.invoice_id |
| users | 顧客情報 | invoices.user_id = users.id |
| companies | 会社情報（自社） | - |

**SQL概要**
```sql
SELECT
    i.invoice_number,
    i.invoice_date,
    i.due_date,
    i.total_amount,
    i.tax_amount,
    u.name AS customer_name,
    u.company_name,
    ii.item_name,
    ii.unit_price,
    ii.quantity,
    ii.amount
FROM invoices i
INNER JOIN users u ON i.user_id = u.id
LEFT JOIN invoice_items ii ON i.id = ii.invoice_id
WHERE i.id = :invoice_id
ORDER BY ii.line_number;
```

#### 5.1.4 出力項目定義
**ヘッダー部**
| 項目名 | データソース | 形式 | 必須 | 備考 |
|-------|------------|------|------|------|
| 帳票タイトル | 固定値 "請求書" | - | ○ | |
| 請求番号 | invoices.invoice_number | INV-YYYY-NNN | ○ | |
| 請求日 | invoices.invoice_date | YYYY年MM月DD日 | ○ | |
| 支払期限 | invoices.due_date | YYYY年MM月DD日 | ○ | |
| 顧客名 | users.name | 文字列 | ○ | 会社名がある場合は会社名も表示 |
| 顧客住所 | users.address | 文字列 | × | |

**明細部**
| 項目名 | データソース | 形式 | 必須 | 備考 |
|-------|------------|------|------|------|
| No | invoice_items.line_number | 数値 | ○ | 連番 |
| 品目 | invoice_items.item_name | 文字列 | ○ | |
| 単価 | invoice_items.unit_price | ¥#,##0 | ○ | |
| 数量 | invoice_items.quantity | #,##0 | ○ | |
| 金額 | invoice_items.amount | ¥#,##0 | ○ | 単価×数量 |

**合計部**
| 項目名 | データソース | 形式 | 必須 | 備考 |
|-------|------------|------|------|------|
| 小計 | SUM(invoice_items.amount) | ¥#,##0 | ○ | |
| 消費税 | invoices.tax_amount | ¥#,##0 | ○ | |
| 合計 | invoices.total_amount | ¥#,##0 | ○ | 税込金額 |

**フッター部**
| 項目名 | データソース | 形式 | 必須 | 備考 |
|-------|------------|------|------|------|
| 振込先銀行 | companies.bank_name | 文字列 | ○ | 自社情報 |
| 振込先支店 | companies.branch_name | 文字列 | ○ | |
| 振込先口座種別 | companies.account_type | 文字列 | ○ | |
| 振込先口座番号 | companies.account_number | 文字列 | ○ | |
| 会社名 | companies.name | 文字列 | ○ | |
| お問い合わせ先 | companies.contact_email | メールアドレス | ○ | |

#### 5.1.5 帳票生成ロジック
1. 指定されたinvoice_idで請求データを取得
2. 顧客情報、自社情報を取得
3. 請求明細を取得（line_number順）
4. テンプレートにデータをバインド
5. PDF生成
6. ファイル名: `invoice_{invoice_number}_{YYYYMMDD}.pdf`
7. 保存先: `s3://bucket/invoices/YYYY/MM/`

#### 5.1.6 バリデーション
| 項目 | 検証内容 |
|------|---------|
| データ存在チェック | 指定されたinvoice_idのデータが存在するか |
| 明細存在チェック | 請求明細が1件以上存在するか |
| 金額整合性チェック | 明細合計 = 小計となっているか |
| 権限チェック | 出力ユーザーに権限があるか |

#### 5.1.7 エラーハンドリング
| エラーケース | 処理 |
|------------|------|
| データ不整合 | エラーメッセージ表示、管理者に通知 |
| PDF生成失敗 | リトライ（3回まで）、失敗時はエラーログ |
| 保存失敗 | リトライ（3回まで）、失敗時はエラーログ |

#### 5.1.8 サンプル画像
[実際のPDFサンプルまたはワイヤーフレーム画像を添付]

---

### 5.2 [帳票ID: R002 納品書]

#### 5.2.1 基本情報
| 項目 | 内容 |
|------|------|
| 帳票ID | R002 |
| 帳票名 | 納品書 |
| 出力形式 | PDF |
| 用紙サイズ | A4縦 |
| 用途 | 商品納品時の証明 |
| 出力タイミング | 出荷ステータス更新時自動生成 |
| 出力権限 | admin, shipping |
| 保存期間 | 5年 |
| 再出力 | 可能 |

[請求書と同様の形式で詳細を記載]

---

### 5.3 [帳票ID: R003 領収書]
[同様に記載]

---

### 5.4 [帳票ID: R004 ユーザー一覧CSV]

#### 5.4.1 基本情報
| 項目 | 内容 |
|------|------|
| 帳票ID | R004 |
| 帳票名 | ユーザー一覧 |
| 出力形式 | CSV |
| 文字コード | UTF-8（BOM付き） |
| 用途 | ユーザーデータのエクスポート |
| 出力タイミング | 管理画面から手動出力 |
| 出力権限 | admin |
| 保存期間 | 出力後削除（ダウンロードのみ） |

#### 5.4.2 データソース
**取得元テーブル**
| テーブル名 | 用途 |
|-----------|------|
| users | ユーザー情報 |

**SQL概要**
```sql
SELECT
    id,
    email,
    name,
    role,
    status,
    created_at,
    updated_at
FROM users
WHERE deleted_at IS NULL
ORDER BY id;
```

#### 5.4.3 出力項目定義
| 列番号 | 列名 | データソース | 形式 | 備考 |
|-------|------|------------|------|------|
| 1 | ID | users.id | 数値 | |
| 2 | メールアドレス | users.email | 文字列 | |
| 3 | 氏名 | users.name | 文字列 | |
| 4 | ロール | users.role | 文字列 | admin/user |
| 5 | ステータス | users.status | 文字列 | active/inactive |
| 6 | 作成日時 | users.created_at | YYYY-MM-DD HH:mm:ss | |
| 7 | 更新日時 | users.updated_at | YYYY-MM-DD HH:mm:ss | |

#### 5.4.4 ヘッダー行
```csv
ID,メールアドレス,氏名,ロール,ステータス,作成日時,更新日時
```

#### 5.4.5 サンプル出力
```csv
ID,メールアドレス,氏名,ロール,ステータス,作成日時,更新日時
1,user1@example.com,山田太郎,admin,active,2024-01-01 00:00:00,2024-01-01 00:00:00
2,user2@example.com,佐藤花子,user,active,2024-01-02 00:00:00,2024-01-02 00:00:00
```

#### 5.4.6 ファイル名
`users_export_{YYYYMMDDHHMMSS}.csv`

---

### 5.5 [帳票ID: R005 月次売上レポート]
[同様に記載]

---

## 6. 帳票テンプレート管理
### 6.1 テンプレート形式
| 帳票種別 | テンプレート形式 | 使用技術 |
|---------|---------------|---------|
| PDF帳票 | HTML + CSS | [例: Handlebars / Jinja2] |
| CSV帳票 | プログラム内で生成 | - |

### 6.2 テンプレートファイル配置
```
templates/
  └── reports/
      ├── R001_invoice.html
      ├── R002_delivery_note.html
      ├── R003_receipt.html
      └── R005_monthly_report.html
```

### 6.3 テンプレート変数
各テンプレートで使用する変数を定義
```html
<!-- R001_invoice.html -->
<div class="invoice">
  <h1>請求書</h1>
  <p>請求No: {{invoiceNumber}}</p>
  <p>請求日: {{invoiceDate}}</p>
  <p>{{customerName}} 御中</p>

  <table>
    {{#each items}}
    <tr>
      <td>{{this.lineNumber}}</td>
      <td>{{this.itemName}}</td>
      <td>{{this.unitPrice}}</td>
      <td>{{this.quantity}}</td>
      <td>{{this.amount}}</td>
    </tr>
    {{/each}}
  </table>

  <p>合計: {{totalAmount}}</p>
</div>
```

## 7. 帳票出力処理
### 7.1 出力フロー
```
1. 出力リクエスト受付（API or バッチ）
2. 権限チェック
3. データ取得（DB, API）
4. データ検証
5. テンプレートにデータバインド
6. 帳票生成（PDF/CSV）
7. ファイル保存
8. レスポンス返却（ダウンロードURL）
```

### 7.2 API設計
#### 7.2.1 帳票出力API
**エンドポイント**: `POST /api/v1/reports/{reportId}/generate`

**リクエスト**
```json
{
  "parameters": {
    "invoiceId": 123
  },
  "format": "pdf"
}
```

**レスポンス**
```json
{
  "reportId": "R001",
  "fileUrl": "https://storage.example.com/reports/invoice_20240101_001.pdf",
  "fileName": "invoice_20240101_001.pdf",
  "generatedAt": "2024-01-01T12:00:00Z",
  "expiresAt": "2024-01-08T12:00:00Z"
}
```

### 7.3 バッチ処理
定期的に自動生成する帳票のバッチ処理

| バッチ名 | 実行タイミング | 対象帳票 | 処理内容 |
|---------|--------------|---------|---------|
| 月次請求書生成 | 毎月末日 23:00 | R001 | 当月分の請求書を全顧客分生成 |
| 月次レポート生成 | 毎月1日 01:00 | R005 | 前月の売上レポート生成 |

## 8. パフォーマンス
### 8.1 生成時間目標
| 帳票種別 | 件数 | 目標時間 |
|---------|------|---------|
| PDF 1件 | - | 3秒以内 |
| CSV 1000件 | - | 5秒以内 |
| バッチ（100件） | - | 5分以内 |

### 8.2 最適化方針
- データ取得のSQLチューニング
- テンプレートキャッシュ
- 非同期処理（大量生成時）
- ページネーション（大量データCSV）

## 9. セキュリティ
### 9.1 アクセス制御
- 帳票出力権限のロールチェック
- 自分に関連する帳票のみ閲覧可能（顧客は自分の請求書のみ）
- 管理者は全帳票閲覧可能

### 9.2 ダウンロードURL
- 署名付きURL（一時的なアクセス権限）
- 有効期限: 7日間
- ワンタイムトークン（必要に応じて）

### 9.3 個人情報保護
- 帳票ファイル名に個人情報を含めない
- ログに帳票内容を出力しない
- 保存期間経過後は自動削除

## 10. エラーハンドリング
### 10.1 エラーケース
| エラー | 原因 | 対処 |
|-------|------|------|
| データ不存在 | 指定IDのデータがない | 404エラー |
| 権限不足 | ロール不足 | 403エラー |
| データ不整合 | 金額計算エラーなど | 500エラー、管理者通知 |
| PDF生成失敗 | ライブラリエラー | リトライ、失敗時はログ |
| 保存失敗 | ストレージエラー | リトライ、失敗時はログ |

### 10.2 リトライポリシー
- 一時的なエラー: 3回まで自動リトライ
- リトライ間隔: 1秒、5秒、10秒
- 永続的なエラー: 管理者に通知

## 11. テスト
### 11.1 テスト観点
- データパターン: 正常、異常、境界値
- レイアウト: ページ分割、長文折り返し
- 多言語: 日本語、英語（必要に応じて）
- ブラウザ互換性: PDF表示確認

### 11.2 テストデータ
- 最小ケース: 明細1件
- 最大ケース: 明細100件（ページ分割確認）
- 特殊文字: 記号、絵文字の表示確認

## 12. 運用
### 12.1 監視項目
| 項目 | しきい値 | アラート |
|------|---------|---------|
| 生成失敗率 | 5%超 | 即時通知 |
| 生成時間 | 目標の2倍超 | 即時通知 |
| ストレージ使用量 | 80%超 | 警告通知 |

### 12.2 ログ出力
- 帳票生成ログ: 帳票ID、パラメータ、生成時間、結果
- エラーログ: エラー詳細、スタックトレース
- アクセスログ: ダウンロード履歴

### 12.3 バックアップ
- 帳票ファイル: 日次バックアップ
- テンプレートファイル: バージョン管理（Git）

## 13. 多言語対応
[必要に応じて]
| 言語 | 対応範囲 | 備考 |
|------|---------|------|
| 日本語 | 全帳票 | デフォルト |
| 英語 | 請求書のみ | ユーザー設定に応じて |

## 14. 印刷設定
### 14.1 印刷推奨設定
| 項目 | 設定値 |
|------|-------|
| 用紙サイズ | A4 |
| 余白 | 上下左右 10mm |
| カラー | モノクロ可 |
| 両面印刷 | 片面 |

### 14.2 PDF設定
| 項目 | 設定値 |
|------|-------|
| PDFバージョン | 1.7 |
| 圧縮 | 有効 |
| セキュリティ | 印刷許可、コピー禁止（必要に応じて） |

## 15. 用語集
| 用語 | 説明 |
|------|------|
| 帳票 | システムから出力される定型フォーマットの文書 |
| テンプレート | 帳票のレイアウト定義 |
| [その他用語] | [説明] |

## 16. 変更履歴
| 版数 | 変更日 | 変更者 | 変更内容 |
|------|-------|--------|---------|
| 1.0 | YYYY/MM/DD | [氏名] | 初版作成 |
