# 運用設計書

## 1. 文書管理情報
- **作成日**: YYYY/MM/DD
- **最終更新日**: YYYY/MM/DD
- **作成者**: [作成者名]
- **バージョン**: 1.0
- **承認者**: [承認者名]

## 2. 概要
### 2.1 目的
[この運用設計書の目的を記載]

### 2.2 対象システム
[対象となるシステム名を記載]

### 2.3 参照ドキュメント
- 要件定義書
- システム構成図
- DB設計書
- [その他関連ドキュメント]

## 3. 運用方針
### 3.1 運用目標
| 項目 | 目標値 | 備考 |
|------|-------|------|
| 稼働率 | 99.9% | 年間ダウンタイム8.76時間以内 |
| レスポンスタイム | 平均500ms以内 | 95パーセンタイル |
| エラー率 | 0.1%以下 | |
| バックアップ成功率 | 100% | |

### 3.2 運用体制
| 役割 | 担当者/チーム | 業務時間 | 責任範囲 |
|------|-------------|---------|---------|
| システム運用責任者 | [氏名] | 平日9:00-18:00 | 運用全体の統括 |
| 運用担当者 | [チーム名] | 24時間365日 | 監視・障害対応 |
| 開発担当者 | [チーム名] | 平日9:00-18:00 | バグ修正・機能追加 |

### 3.3 運用時間
| 項目 | 内容 |
|------|------|
| サービス提供時間 | 24時間365日 |
| メンテナンス時間 | 毎月第2日曜日 2:00-4:00 |
| サポート対応時間 | 平日9:00-18:00（緊急時は24時間対応） |

### 3.4 SLA (Service Level Agreement)
| 項目 | SLA | 測定方法 |
|------|-----|---------|
| 可用性 | 99.9% | (稼働時間 / 総時間) × 100 |
| レスポンスタイム | 95%が500ms以内 | APM監視ツール |
| 障害復旧時間 | 重大: 1時間以内、軽微: 4時間以内 | インシデント管理システム |

## 4. 監視
### 4.1 監視項目
#### 4.1.1 インフラ監視
| 監視対象 | 監視項目 | 正常範囲 | 警告しきい値 | 異常しきい値 | 監視間隔 |
|---------|---------|---------|------------|------------|---------|
| Webサーバー | CPU使用率 | 0-60% | 70% | 85% | 1分 |
| Webサーバー | メモリ使用率 | 0-70% | 80% | 90% | 1分 |
| Webサーバー | ディスク使用率 | 0-70% | 80% | 90% | 5分 |
| DBサーバー | CPU使用率 | 0-60% | 70% | 85% | 1分 |
| DBサーバー | メモリ使用率 | 0-70% | 80% | 90% | 1分 |
| DBサーバー | ディスク使用率 | 0-70% | 80% | 90% | 5分 |
| DBサーバー | 接続数 | 0-80 | 90 | 100 | 1分 |
| ネットワーク | 帯域使用率 | 0-70% | 80% | 90% | 1分 |

#### 4.1.2 アプリケーション監視
| 監視対象 | 監視項目 | 正常範囲 | 警告しきい値 | 異常しきい値 | 監視間隔 |
|---------|---------|---------|------------|------------|---------|
| API | レスポンスタイム | 0-300ms | 500ms | 1000ms | 1分 |
| API | エラー率 | 0-0.05% | 0.1% | 1% | 1分 |
| API | リクエスト数 | - | 想定の150% | 想定の200% | 1分 |
| バッチ | 実行成功率 | 100% | 99% | 95% | 実行毎 |
| バッチ | 実行時間 | - | 想定の150% | 想定の200% | 実行毎 |

#### 4.1.3 ビジネス監視
| 監視対象 | 監視項目 | 正常範囲 | 警告しきい値 | 異常しきい値 | 監視間隔 |
|---------|---------|---------|------------|------------|---------|
| ユーザー登録 | 登録成功率 | 95%以上 | 90% | 80% | 10分 |
| 決済 | 決済成功率 | 98%以上 | 95% | 90% | 5分 |
| ログイン | ログイン成功率 | 95%以上 | 90% | 80% | 5分 |

### 4.2 監視ツール
| ツール名 | 用途 | 対象 |
|---------|------|------|
| [例: Datadog / CloudWatch] | インフラ・アプリ監視 | 全サーバー |
| [例: New Relic / Dynatrace] | APM | アプリケーション |
| [例: PagerDuty] | アラート管理 | 全監視項目 |
| [例: Sentry] | エラートラッキング | アプリケーション |

### 4.3 アラート設定
#### 4.3.1 アラート通知先
| アラートレベル | 通知先 | 通知方法 | 通知タイミング |
|-------------|-------|---------|--------------|
| 緊急 (Critical) | 運用担当者、責任者 | 電話、SMS、メール | 即時 |
| 警告 (Warning) | 運用担当者 | メール、Slack | 即時 |
| 情報 (Info) | 運用担当者 | Slack | 即時 |

#### 4.3.2 アラートエスカレーション
| 時間経過 | アクション |
|---------|----------|
| 0分 | 一次担当者に通知 |
| 15分 | 未対応の場合、二次担当者に通知 |
| 30分 | 未対応の場合、責任者に通知 |
| 1時間 | 未対応の場合、経営層に通知 |

### 4.4 ヘルスチェック
| 対象 | エンドポイント/方法 | チェック間隔 | タイムアウト | 期待する結果 |
|------|------------------|------------|------------|------------|
| Webサーバー | GET /health | 30秒 | 5秒 | 200 OK |
| APIサーバー | GET /api/v1/health | 30秒 | 5秒 | 200 OK |
| DBサーバー | TCP接続チェック | 30秒 | 5秒 | 接続成功 |

## 5. ログ管理
### 5.1 ログ種別
| ログ種別 | 内容 | 出力先 | 保存期間 | ローテーション |
|---------|------|-------|---------|--------------|
| アクセスログ | HTTP リクエスト/レスポンス | CloudWatch Logs | 90日 | 日次 |
| アプリケーションログ | アプリの動作ログ | CloudWatch Logs | 90日 | 日次 |
| エラーログ | エラー、スタックトレース | CloudWatch Logs | 180日 | 日次 |
| 監査ログ | 重要操作の履歴 | S3 | 1年 | 日次 |
| バッチログ | バッチ処理の実行ログ | CloudWatch Logs | 90日 | 日次 |

### 5.2 ログフォーマット
**アクセスログ**
```
[2024-01-01T12:00:00Z] INFO 192.168.1.1 - "GET /api/v1/users HTTP/1.1" 200 1234 0.123s
```

**アプリケーションログ**
```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "level": "INFO",
  "message": "User login successful",
  "userId": 123,
  "requestId": "req-abc123"
}
```

**エラーログ**
```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "level": "ERROR",
  "message": "Database connection failed",
  "error": "Connection timeout",
  "stackTrace": "...",
  "requestId": "req-abc123"
}
```

### 5.3 ログレベル
| レベル | 用途 | 本番環境出力 |
|-------|------|------------|
| DEBUG | デバッグ情報 | × |
| INFO | 通常の動作情報 | ○ |
| WARNING | 警告（処理は継続） | ○ |
| ERROR | エラー（処理失敗） | ○ |
| CRITICAL | 致命的エラー | ○ |

### 5.4 ログ分析
- ログ集約ツール: [例: ELK Stack / Splunk]
- 定期レビュー: 週次でエラーログを分析
- 異常検知: エラー率の急増を自動検知

## 6. バックアップ・リストア
### 6.1 バックアップ方針
| 対象 | バックアップ種別 | 頻度 | 世代管理 | 保存先 | 保存期間 |
|------|---------------|------|---------|-------|---------|
| データベース | フルバックアップ | 日次（深夜2:00） | 30世代 | S3 | 30日 |
| データベース | 増分バックアップ | 1時間毎 | 24世代 | S3 | 24時間 |
| ファイル | フルバックアップ | 日次（深夜3:00） | 30世代 | S3 | 30日 |
| システム設定 | フルバックアップ | 変更時 | 10世代 | Git/S3 | 無期限 |
| アプリケーションコード | - | - | - | Git | 無期限 |

### 6.2 バックアップ手順
#### 6.2.1 データベースバックアップ
```bash
# フルバックアップ
pg_dump -h ${DB_HOST} -U ${DB_USER} ${DB_NAME} | gzip > backup_$(date +%Y%m%d).sql.gz
aws s3 cp backup_$(date +%Y%m%d).sql.gz s3://bucket/backups/db/

# 増分バックアップ（WALアーカイブ）
# PostgreSQLのWALアーカイブ機能を使用
```

#### 6.2.2 ファイルバックアップ
```bash
# ファイルバックアップ
tar -czf files_backup_$(date +%Y%m%d).tar.gz /path/to/files
aws s3 cp files_backup_$(date +%Y%m%d).tar.gz s3://bucket/backups/files/
```

### 6.3 リストア手順
#### 6.3.1 データベースリストア
```bash
# フルリストア
aws s3 cp s3://bucket/backups/db/backup_20240101.sql.gz .
gunzip backup_20240101.sql.gz
psql -h ${DB_HOST} -U ${DB_USER} ${DB_NAME} < backup_20240101.sql

# ポイントインタイムリカバリ
# WALファイルを使用して特定時点まで復元
```

#### 6.3.2 ファイルリストア
```bash
aws s3 cp s3://bucket/backups/files/files_backup_20240101.tar.gz .
tar -xzf files_backup_20240101.tar.gz -C /path/to/restore/
```

### 6.4 バックアップ検証
| 項目 | 頻度 | 方法 |
|------|------|------|
| バックアップ成功確認 | 日次 | バックアップログ確認 |
| リストアテスト | 月次 | ステージング環境でリストア実施 |
| データ整合性確認 | 月次 | リストア後のデータ件数、整合性チェック |

### 6.5 RPO/RTO
| 項目 | 目標値 | 実現方法 |
|------|-------|---------|
| RPO (Recovery Point Objective) | 1時間 | 1時間毎の増分バックアップ |
| RTO (Recovery Time Objective) | 4時間 | 手順書整備、定期訓練 |

## 7. デプロイ・リリース
### 7.1 デプロイフロー
```
1. コードレビュー → 2. マージ → 3. CI実行（ビルド・テスト）
→ 4. ステージング環境デプロイ → 5. 動作確認 → 6. 本番環境デプロイ
```

### 7.2 デプロイ方式
| 環境 | デプロイ方式 | タイミング | 承認者 |
|------|-----------|-----------|-------|
| 開発環境 | 自動デプロイ | mainブランチマージ時 | 不要 |
| ステージング環境 | 自動デプロイ | releaseブランチ作成時 | 不要 |
| 本番環境 | 手動デプロイ | リリース予定日時 | リリース責任者 |

### 7.3 デプロイ戦略
| 項目 | 内容 |
|------|------|
| デプロイ手法 | ブルー・グリーンデプロイ |
| ロールバック方針 | デプロイ後1時間以内に重大な問題が発生した場合は即座にロールバック |
| ダウンタイム | 原則0秒（ブルー・グリーンで実現） |

### 7.4 リリーススケジュール
| リリース種別 | 頻度 | タイミング | 内容 |
|------------|------|-----------|------|
| メジャーリリース | 半年に1回 | 4月、10月 | 大規模機能追加 |
| マイナーリリース | 月1回 | 毎月第2火曜日 | 機能追加、改善 |
| パッチリリース | 随時 | 緊急時 | バグ修正、セキュリティ対応 |

### 7.5 リリース前チェックリスト
- [ ] コードレビュー完了
- [ ] 単体テスト合格
- [ ] 結合テスト合格
- [ ] ステージング環境で動作確認完了
- [ ] データベースマイグレーション確認
- [ ] バックアップ取得完了
- [ ] ロールバック手順確認
- [ ] リリース責任者の承認取得
- [ ] 関係者への通知完了

### 7.6 ロールバック手順
1. 問題の検知・判断（リリース責任者）
2. ロールバック開始宣言
3. 前バージョンへの切り戻し（ブルー・グリーン切替）
4. 動作確認
5. ロールバック完了宣言
6. 原因調査・対策

## 8. バッチ処理
### 8.1 バッチ一覧
| バッチID | バッチ名 | 実行タイミング | 実行時間 | 処理内容 | 失敗時の対応 |
|---------|---------|--------------|---------|---------|------------|
| B001 | 日次バックアップ | 日次 | 深夜2:00 | DBフルバックアップ | 再実行、失敗時アラート |
| B002 | ユーザーデータ集計 | 日次 | 深夜3:00 | ユーザー統計の集計 | 再実行 |
| B003 | 月次請求書生成 | 月次 | 月末23:00 | 請求書PDF生成 | 手動再実行 |
| B004 | ログクリーンアップ | 日次 | 深夜4:00 | 古いログの削除 | 翌日再実行 |

### 8.2 バッチ実行基盤
| 項目 | 内容 |
|------|------|
| 実行方式 | [例: AWS Batch / Kubernetes CronJob] |
| スケジューラー | [例: CloudWatch Events / Cron] |
| リトライポリシー | 失敗時3回まで自動リトライ（間隔: 5分、15分、30分） |

### 8.3 バッチ監視
- 実行開始・終了ログの記録
- 実行時間の監視（想定時間の150%超でアラート）
- 処理件数の記録（前日比で大幅な変動があればアラート）
- 失敗時の即時アラート

### 8.4 バッチ依存関係
```
B001 (バックアップ) → B002 (集計)
                   → B004 (ログクリーンアップ)
```

## 9. 障害対応
### 9.1 障害レベル定義
| レベル | 定義 | 対応時間 | エスカレーション |
|-------|------|---------|----------------|
| Critical | サービス全停止 | 即時対応 | 即座に責任者へ |
| High | 主要機能停止 | 1時間以内 | 30分後に責任者へ |
| Medium | 一部機能停止 | 4時間以内 | 2時間後に責任者へ |
| Low | 軽微な不具合 | 1営業日以内 | 報告のみ |

### 9.2 障害対応フロー
```
1. 障害検知 → 2. 一次切り分け → 3. 関係者通知 → 4. 原因調査
→ 5. 暫定対応 → 6. 恒久対応 → 7. 報告書作成 → 8. 再発防止策実施
```

### 9.3 障害対応手順書
主要な障害パターンごとに手順書を用意：
- Webサーバーダウン
- DBサーバーダウン
- ディスク容量不足
- ネットワーク障害
- アプリケーションエラー急増

### 9.4 インシデント管理
| 項目 | 内容 |
|------|------|
| 管理ツール | [例: Jira Service Management / PagerDuty] |
| 記録項目 | 発生日時、内容、影響範囲、対応内容、根本原因、再発防止策 |
| 定期レビュー | 月次でインシデントを分析、傾向把握 |

### 9.5 障害通知
| 対象 | 通知方法 | 通知タイミング |
|------|---------|--------------|
| 内部運用チーム | Slack、メール | 即時 |
| 開発チーム | Slack | 即時（開発対応が必要な場合） |
| ユーザー | サービスステータスページ | 主要機能停止時 |
| 経営層 | メール | Critical、High障害時 |

## 10. セキュリティ運用
### 10.1 脆弱性管理
| 項目 | 頻度 | 内容 |
|------|------|------|
| 脆弱性スキャン | 週次 | OSパッケージ、ライブラリの脆弱性チェック |
| セキュリティパッチ適用 | 月次 | 脆弱性パッチの適用 |
| ペネトレーションテスト | 年次 | 外部専門家による侵入テスト |

### 10.2 アクセス管理
| 項目 | 内容 |
|------|------|
| アクセス権限レビュー | 四半期毎に権限を棚卸し、不要な権限を削除 |
| アカウント管理 | 退職者のアカウント即座削除 |
| 多要素認証 | 本番環境へのアクセスは必須 |
| パスワードポリシー | 最小12文字、英数字記号混在、90日毎に変更 |

### 10.3 監査ログレビュー
- 重要操作の監査ログを週次でレビュー
- 不審なアクセスパターンの検知
- 権限昇格操作の記録と確認

### 10.4 インシデントレスポンス
セキュリティインシデント発生時の対応手順：
1. 検知・報告
2. 初動対応（影響範囲の特定、被害拡大防止）
3. 詳細調査
4. 復旧作業
5. 事後対応（報告、再発防止）

## 11. キャパシティ管理
### 11.1 リソース使用状況
| リソース | 現在使用量 | 上限 | 使用率 | 次回拡張予定 |
|---------|----------|------|-------|------------|
| Webサーバー台数 | 2台 | 10台 | 20% | 使用率70%到達時 |
| DBストレージ | 100GB | 500GB | 20% | 使用率70%到達時 |
| 帯域 | 10Mbps | 100Mbps | 10% | 使用率70%到達時 |

### 11.2 キャパシティ予測
- 月次でリソース使用率をレビュー
- トレンド分析により拡張時期を予測
- 大規模イベント前には事前にスケールアウト

### 11.3 スケーリング計画
| トリガー | スケーリング内容 | 実施タイミング |
|---------|---------------|--------------|
| CPU使用率70%が30分継続 | Webサーバー1台追加 | 自動 |
| ストレージ使用率70% | ストレージ拡張 | 手動（計画的） |
| 大規模イベント | 事前にWebサーバー2倍化 | 手動（事前計画） |

## 12. 変更管理
### 12.1 変更管理プロセス
```
1. 変更申請 → 2. 影響評価 → 3. 承認 → 4. 実施計画
→ 5. 変更実施 → 6. 確認 → 7. 完了報告
```

### 12.2 変更カテゴリ
| カテゴリ | 内容 | 承認者 | 実施タイミング |
|---------|------|-------|--------------|
| 標準変更 | 定型的な変更 | チームリーダー | 即時可 |
| 通常変更 | 影響が限定的 | 運用責任者 | 計画的 |
| 重大変更 | 影響が大きい | 経営層 | 十分な準備期間 |
| 緊急変更 | 緊急対応 | 運用責任者 | 即時（事後報告） |

### 12.3 変更記録
全ての変更を記録し、以下を含める：
- 変更日時
- 変更内容
- 変更理由
- 影響範囲
- 実施者
- 承認者
- ロールバック手順

## 13. ドキュメント管理
### 13.1 運用ドキュメント一覧
| ドキュメント名 | 更新頻度 | 管理場所 | 責任者 |
|--------------|---------|---------|-------|
| 運用手順書 | 変更時 | Wiki/Git | 運用責任者 |
| 障害対応手順書 | 変更時 | Wiki/Git | 運用責任者 |
| システム構成図 | 変更時 | Wiki/Git | システム責任者 |
| 連絡先一覧 | 四半期毎 | Wiki | 運用責任者 |
| FAQ | 随時 | Wiki | 運用担当者 |

### 13.2 ドキュメント更新プロセス
- システム変更時に関連ドキュメントも更新
- 四半期毎にドキュメントレビュー
- 古いドキュメントは削除または「非推奨」マーク

## 14. 定期作業
### 14.1 日次作業
| 作業項目 | 実施時間 | 担当者 | 内容 |
|---------|---------|-------|------|
| 監視ダッシュボード確認 | 9:00 | 運用担当者 | 前日のアラート、エラーログ確認 |
| バックアップ成功確認 | 9:30 | 運用担当者 | バックアップログ確認 |
| ディスク使用量確認 | 10:00 | 運用担当者 | 使用率70%超がないか確認 |

### 14.2 週次作業
| 作業項目 | 実施日時 | 担当者 | 内容 |
|---------|---------|-------|------|
| エラーログ分析 | 毎週月曜10:00 | 運用担当者 | 週次エラー傾向分析 |
| 脆弱性スキャン | 毎週水曜深夜 | 自動 | OSパッケージ、ライブラリスキャン |

### 14.3 月次作業
| 作業項目 | 実施日 | 担当者 | 内容 |
|---------|-------|-------|------|
| バックアップリストアテスト | 第1月曜 | 運用担当者 | ステージング環境でリストア実施 |
| パッチ適用 | 第2火曜メンテナンス時 | 運用担当者 | OSセキュリティパッチ適用 |
| キャパシティレビュー | 月初 | 運用責任者 | リソース使用状況レビュー |
| インシデントレビュー | 月初 | 運用責任者 | 前月のインシデント分析 |

### 14.4 年次作業
| 作業項目 | 実施時期 | 担当者 | 内容 |
|---------|---------|-------|------|
| DR訓練 | 年1回 | 全体 | ディザスタリカバリ訓練 |
| セキュリティ監査 | 年1回 | 外部専門家 | セキュリティ全般の監査 |
| 運用プロセス改善 | 年1回 | 運用責任者 | 運用プロセスの見直し |

## 15. 災害対策 (DR: Disaster Recovery)
### 15.1 災害シナリオ
| シナリオ | 発生確率 | 影響度 | 対策 |
|---------|---------|-------|------|
| データセンター障害 | 低 | 高 | マルチAZ構成 |
| リージョン障害 | 極低 | 極高 | マルチリージョンバックアップ |
| サイバー攻撃 | 中 | 高 | WAF、IDS/IPS、定期監査 |
| 人為的ミス | 中 | 中 | 権限管理、変更管理プロセス |

### 15.2 DR計画
| 項目 | 内容 |
|------|------|
| DR目標 | RPO: 1時間、RTO: 4時間 |
| DR構成 | 別リージョンにバックアップ保管 |
| DR訓練 | 年1回、フェイルオーバー訓練実施 |
| DR手順書 | 詳細な復旧手順を文書化 |

### 15.3 事業継続計画 (BCP)
災害時の業務継続方針を定義：
- 最優先機能: [主要機能を列挙]
- 代替手段: 手動運用の手順
- 復旧優先順位: システムコンポーネントの復旧順序

## 16. コスト管理
### 16.1 コスト監視
| 項目 | 月額予算 | アラートしきい値 | 確認頻度 |
|------|---------|---------------|---------|
| インフラコスト全体 | ¥500,000 | ¥550,000 (110%) | 日次 |
| EC2 | ¥200,000 | ¥220,000 | 日次 |
| RDS | ¥150,000 | ¥165,000 | 日次 |
| S3 | ¥50,000 | ¥55,000 | 週次 |

### 16.2 コスト最適化
- 未使用リソースの定期削除
- リザーブドインスタンスの活用
- ストレージのライフサイクル管理（古いデータをGlacierへ）
- 月次コストレビュー会議

## 17. 教育・トレーニング
### 17.1 トレーニング計画
| 対象者 | トレーニング内容 | 頻度 |
|-------|---------------|------|
| 新規運用担当者 | 運用手順、障害対応 | 配属時 |
| 全運用担当者 | 新機能、変更点 | リリース毎 |
| 全運用担当者 | DR訓練 | 年1回 |

### 17.2 ナレッジ共有
- 障害対応事例の共有（週次ミーティング）
- FAQの継続的更新
- ベストプラクティスの文書化

## 18. 用語集
| 用語 | 説明 |
|------|------|
| SLA | Service Level Agreement - サービスレベル合意 |
| RPO | Recovery Point Objective - 目標復旧時点 |
| RTO | Recovery Time Objective - 目標復旧時間 |
| DR | Disaster Recovery - 災害復旧 |
| [その他用語] | [説明] |

## 19. 変更履歴
| 版数 | 変更日 | 変更者 | 変更内容 |
|------|-------|--------|---------|
| 1.0 | YYYY/MM/DD | [氏名] | 初版作成 |
