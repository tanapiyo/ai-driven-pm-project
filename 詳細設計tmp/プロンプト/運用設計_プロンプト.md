# 運用設計作成プロンプト

## 目的
要件定義書の内容を基に、システムを安定的に稼働させるための運用設計書を作成します。

## インプット
以下のドキュメントを読み込んでください：
1. **要件定義書**: `[要件定義書のパス]`
2. **システム構成図**: `詳細設計tmp/システム構成図.md`
3. **DB設計書**: `詳細設計tmp/DB設計.md`（バックアップ設計に使用）

## 出力指示
`詳細設計tmp/テンプレート/運用設計.md` のテンプレートを使用して、運用設計書を作成してください。

## 作成ガイドライン

### 1. 要件定義書の分析
まず、以下の情報を要件定義書から抽出してください：

#### 1.1 非機能要件の確認
- **可用性要件**: 稼働率、ダウンタイム許容度 → SLA、監視設計
- **性能要件**: レスポンスタイム、同時アクセス数 → 監視項目、キャパシティ管理
- **セキュリティ要件**: アクセス制御、監査ログ → セキュリティ運用
- **バックアップ要件**: RPO/RTO → バックアップ・リストア設計
- **運用要件**: 運用時間、サポート体制、メンテナンス時間

#### 1.2 機能要件の確認
- **バッチ処理**: 定期実行する処理 → バッチ設計
- **データ保持期間**: ログ、バックアップの保存期間
- **外部連携**: 外部システムとの連携監視

### 2. 運用設計の進め方

#### ステップ1: 運用方針の決定
1. **運用目標の設定**: 要件から稼働率、レスポンスタイム等の目標を設定
2. **SLAの定義**: 要件の非機能要件をSLAとして明文化
3. **運用体制**: 運用担当者、責任者、サポート時間を定義
4. **運用時間**: サービス提供時間、メンテナンス時間

#### ステップ2: 監視設計
1. **監視項目の洗い出し**: インフラ、アプリケーション、ビジネスの3レイヤー
2. **しきい値の設定**: 要件の性能目標から警告・異常しきい値を算出
3. **アラート設計**: 通知先、エスカレーション
4. **ヘルスチェック**: エンドポイント、チェック間隔

#### ステップ3: ログ管理設計
1. **ログ種別の定義**: アクセスログ、アプリログ、エラーログ、監査ログ
2. **ログフォーマット**: 構造化ログ（JSON推奨）
3. **保存期間**: 法的要件、運用要件から決定
4. **ログ分析**: ツール、定期レビュー

#### ステップ4: バックアップ・リストア設計
1. **RPO/RTO**: 要件から目標値を設定
2. **バックアップ方針**: 対象、頻度、世代管理、保存先
3. **リストア手順**: 詳細な復旧手順
4. **バックアップ検証**: 定期的なリストアテスト

#### ステップ5: バッチ処理設計
1. **バッチ一覧**: 要件からバッチ処理を洗い出し
2. **実行タイミング**: スケジュール設定
3. **依存関係**: バッチ間の依存を定義
4. **監視**: 実行状況、失敗時のアラート

#### ステップ6: 障害対応設計
1. **障害レベル定義**: Critical, High, Medium, Lowの定義
2. **対応フロー**: 検知→切り分け→対応→報告の流れ
3. **手順書**: 主要障害パターンの対応手順
4. **インシデント管理**: 記録、分析、再発防止

### 3. 各セクションの作成指示

#### 3.1 運用方針 (セクション3)
- **運用目標**: 要件の非機能要件から稼働率、レスポンスタイム等を設定
- **運用体制**: 役割、担当者、業務時間、責任範囲
- **運用時間**: サービス提供時間、メンテナンス時間
- **SLA**: 可用性、レスポンスタイム、障害復旧時間の目標値

#### 3.2 監視 (セクション4)
**監視項目の設計**:
- **インフラ監視**: CPU、メモリ、ディスク、ネットワーク
  - しきい値: 正常 < 警告 < 異常
  - 警告: 70-80%、異常: 85-90%程度
- **アプリケーション監視**: レスポンスタイム、エラー率、リクエスト数
  - 要件の性能目標から設定
- **ビジネス監視**: ユーザー登録成功率、決済成功率等
  - ビジネスKPIの異常を検知

**監視ツール**:
- インフラ: Datadog, CloudWatch, Prometheus等
- APM: New Relic, Dynatrace等
- アラート管理: PagerDuty等

**アラート設定**:
- 通知先: 運用担当者、責任者、経営層
- エスカレーション: 未対応時の段階的エスカレーション
- 通知方法: メール、Slack、SMS、電話

#### 3.3 ログ管理 (セクション5)
- **ログ種別**: アクセス、アプリ、エラー、監査、バッチ
- **ログフォーマット**: JSON形式で構造化（timestamp, level, message, etc.）
- **保存期間**:
  - アクセスログ: 90日
  - エラーログ: 180日
  - 監査ログ: 1年以上（法的要件に応じて）
- **ログレベル**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **ログ分析**: ELK Stack, Splunk等で集約・分析

#### 3.4 バックアップ・リストア (セクション6)
- **RPO/RTO**: 要件から設定（例: RPO 1時間、RTO 4時間）
- **バックアップ方針**:
  - DB: フルバックアップ（日次）+ 増分（1時間毎）
  - ファイル: フルバックアップ（日次）
  - システム設定: 変更時
- **リストア手順**: 詳細なステップ（SQL例、コマンド例を含む）
- **バックアップ検証**: 月次でリストアテスト実施

#### 3.5 デプロイ・リリース (セクション7)
- **デプロイフロー**: コードレビュー → CI → ステージング → 本番
- **デプロイ方式**: ブルー・グリーン、カナリアリリース等
- **リリーススケジュール**: メジャー、マイナー、パッチリリースの頻度
- **リリース前チェックリスト**: テスト完了、バックアップ、承認等
- **ロールバック手順**: 問題発生時の迅速な切り戻し手順

#### 3.6 バッチ処理 (セクション8)
- **バッチ一覧**: ID、名前、実行タイミング、処理内容
- **実行基盤**: AWS Batch, Kubernetes CronJob等
- **リトライポリシー**: 失敗時の自動リトライ（回数、間隔）
- **バッチ監視**: 実行開始・終了ログ、実行時間、処理件数
- **バッチ依存関係**: 前提バッチの完了を待つ等

#### 3.7 障害対応 (セクション9)
- **障害レベル定義**:
  - Critical: サービス全停止、即時対応
  - High: 主要機能停止、1時間以内
  - Medium: 一部機能停止、4時間以内
  - Low: 軽微な不具合、1営業日以内
- **障害対応フロー**: 検知 → 切り分け → 通知 → 調査 → 対応 → 報告
- **障害対応手順書**: 主要パターン（サーバーダウン、DB障害等）
- **インシデント管理**: ツール（Jira等）、記録項目、定期レビュー
- **障害通知**: 内部チーム、ユーザー、経営層への通知方法

#### 3.8 セキュリティ運用 (セクション10)
- **脆弱性管理**: 週次スキャン、月次パッチ適用、年次ペネトレーションテスト
- **アクセス管理**: 権限レビュー、アカウント管理、多要素認証、パスワードポリシー
- **監査ログレビュー**: 重要操作の週次レビュー
- **インシデントレスポンス**: セキュリティインシデント発生時の対応手順

#### 3.9 キャパシティ管理 (セクション11)
- **リソース使用状況**: 現在値、上限、使用率、拡張予定
- **キャパシティ予測**: 月次レビュー、トレンド分析
- **スケーリング計画**: トリガー条件、スケーリング内容、実施タイミング
- 要件の成長予測を反映

#### 3.10 変更管理 (セクション12)
- **変更管理プロセス**: 申請 → 評価 → 承認 → 実施 → 確認 → 報告
- **変更カテゴリ**: 標準、通常、重大、緊急
- **変更記録**: 日時、内容、理由、影響範囲、実施者、承認者

#### 3.11 ドキュメント管理 (セクション13)
- 運用手順書、障害対応手順書、システム構成図、連絡先一覧、FAQ
- 更新頻度、管理場所、責任者
- ドキュメント更新プロセス、定期レビュー

#### 3.12 定期作業 (セクション14)
- **日次**: 監視確認、バックアップ成功確認、ディスク使用量確認
- **週次**: エラーログ分析、脆弱性スキャン
- **月次**: バックアップリストアテスト、パッチ適用、キャパシティレビュー、インシデントレビュー
- **年次**: DR訓練、セキュリティ監査、運用プロセス改善

#### 3.13 災害対策 (セクション15)
- **災害シナリオ**: データセンター障害、リージョン障害、サイバー攻撃、人為的ミス
- **DR計画**: RPO/RTO、DR構成、DR訓練
- **BCP**: 最優先機能、代替手段、復旧優先順位

#### 3.14 コスト管理 (セクション16)
- **コスト監視**: 月額予算、アラートしきい値、確認頻度
- **コスト最適化**: 未使用リソース削除、リザーブドインスタンス、ライフサイクル管理

#### 3.15 教育・トレーニング (セクション17)
- 新規運用担当者向けトレーニング
- 定期的なDR訓練
- ナレッジ共有、FAQ更新

### 4. 運用設計の重要ポイント

#### 4.1 要件との紐付け
- 非機能要件の数値をそのまま運用目標・SLAに反映
- 例: 要件「稼働率99.9%」→ SLA「稼働率99.9%」

#### 4.2 監視設計
- **3レイヤー監視**: インフラ、アプリケーション、ビジネス
- **しきい値設定**: 余裕を持った警告しきい値で事前検知
- **エスカレーション**: 未対応時の段階的エスカレーション

#### 4.3 バックアップ設計
- **3-2-1ルール**: 3つのコピー、2種類のメディア、1つはオフサイト
- **定期検証**: バックアップが取れているだけでは不十分、リストアテストが必須
- **RPO/RTO達成**: 要件を満たすバックアップ頻度とリストア手順

#### 4.4 障害対応
- **迅速な初動**: 自動検知、即時アラート、エスカレーション
- **手順書整備**: 主要パターンの詳細手順を事前に用意
- **定期訓練**: 年1回以上のDR訓練で手順を検証

#### 4.5 セキュリティ
- **多層防御**: ネットワーク、OS、アプリケーション各層でのセキュリティ対策
- **定期的な点検**: 脆弱性スキャン、パッチ適用、権限レビュー
- **監査証跡**: 重要操作の記録と定期レビュー

#### 4.6 自動化
- **バックアップ**: 手動ではなく自動化
- **監視アラート**: 自動検知、自動通知
- **デプロイ**: CI/CDパイプラインによる自動化
- **バッチ**: スケジューラーによる自動実行

#### 4.7 ドキュメント化
- **手順書**: 誰でも実施できる詳細な手順
- **常に最新**: システム変更時にドキュメントも更新
- **アクセス性**: 緊急時にすぐアクセスできる場所に保管

### 5. チェックリスト
作成後、以下を確認してください：

**運用方針**
- [ ] 運用目標が要件の非機能要件と一致している
- [ ] SLAが明確に定義されている
- [ ] 運用体制（役割、責任者）が明確である
- [ ] 運用時間、メンテナンス時間が定義されている

**監視**
- [ ] インフラ監視項目が網羅的である
- [ ] アプリケーション監視が性能要件をカバーしている
- [ ] しきい値が適切である（警告 < 異常）
- [ ] アラート通知先が明確である
- [ ] エスカレーション手順が定義されている
- [ ] ヘルスチェックが設定されている

**ログ管理**
- [ ] 必要なログ種別が全て定義されている
- [ ] ログフォーマットが構造化されている
- [ ] 保存期間が法的要件を満たしている
- [ ] ログ分析の方法が明確である

**バックアップ・リストア**
- [ ] RPO/RTOが要件を満たしている
- [ ] バックアップ対象が網羅的である
- [ ] バックアップ頻度がRPOを満たしている
- [ ] リストア手順が詳細に記載されている
- [ ] バックアップ検証（リストアテスト）が計画されている

**デプロイ・リリース**
- [ ] デプロイフローが明確である
- [ ] リリーススケジュールが定義されている
- [ ] リリース前チェックリストが網羅的である
- [ ] ロールバック手順が明確である

**バッチ処理**
- [ ] 全バッチ処理が一覧化されている
- [ ] 実行タイミングが明確である
- [ ] 依存関係が定義されている
- [ ] 監視項目が設定されている
- [ ] 失敗時の対応が明確である

**障害対応**
- [ ] 障害レベルが明確に定義されている
- [ ] 障害対応フローが明確である
- [ ] 主要障害パターンの手順書がある
- [ ] インシデント管理方法が定義されている
- [ ] 障害通知先が明確である

**セキュリティ運用**
- [ ] 脆弱性管理プロセスが定義されている
- [ ] アクセス管理ポリシーが明確である
- [ ] 監査ログレビュープロセスがある
- [ ] インシデントレスポンス手順が定義されている

**キャパシティ管理**
- [ ] 現在のリソース使用状況が記載されている
- [ ] キャパシティ予測方法が定義されている
- [ ] スケーリング計画が明確である

**定期作業**
- [ ] 日次、週次、月次、年次の作業が定義されている
- [ ] 各作業の実施日時、担当者が明確である

**災害対策**
- [ ] 災害シナリオが想定されている
- [ ] DR計画が要件のRPO/RTOを満たしている
- [ ] DR訓練が計画されている

**ドキュメント**
- [ ] 必要な運用ドキュメントがリストアップされている
- [ ] 更新頻度、責任者が明確である
- [ ] ドキュメント更新プロセスが定義されている

## 出力形式
- テンプレートの構造を維持
- 各項目を過不足なく埋める
- 表は見やすく整形
- 手順は具体的なコマンド例を含める

## 記載時の注意事項

### 具体性
- 抽象的な表現を避け、具体的な数値、ツール名、手順を記載
- 例: ✗「適切に監視」→ ✓「CPU使用率が70%を超えた場合にSlackで警告通知」

### 要件との紐付け
- 非機能要件の数値をそのまま運用目標・SLAに反映
- 例: 「要件定義書4.2.1の可用性要件99.9%をSLAとして設定」

### 実装可能性
- 実際に運用可能な手順、ツール、体制
- 一般的な運用ツールを使用

### 一貫性
- 用語の統一（例: 障害レベル、ログ種別）
- 数値の整合性（RPO/RTO、しきい値）

## 最終出力先
`詳細設計tmp/運用設計.md` に保存してください。
